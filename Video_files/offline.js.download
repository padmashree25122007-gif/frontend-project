(function(g){var window=this;'use strict';var h4H=function(S){const W=new g.Fv("und",new g.k1("Default","und",!0));W.captionTracks=S.captionTracks;return W},tsv=function(S){return new g.d0(function(W,m){let a=S.length;
const J=[];if(a){var B=function(y,Y){a--;J[y]=Y;a==0&&W(J)},E=function(y){m(y)};
for(let y=0;y<S.length;y++){var z=S[y];g.AX(z,g.w7(B,y),E)}}else W(J)})},Ab8=function({type:S,
payload:W}){S={type:S};W!==void 0&&(S.payload=W);return S},nS=function(S){S=S.key||S.id;
if(!S)throw Error("Entity key is missing");return S},Zhn=function(){if(s5)return s5();
s5=g.pU("PersistentEntityStoreDb",{fU:{EntityStore:{V4:1},EntityAssociationStore:{V4:2}},shared:!1,upgrade(S,W){W(1)&&g.wl(g.rl(S,"EntityStore",{keyPath:"key"}),"entityType","entityType");W(2)&&(S=g.rl(S,"EntityAssociationStore",{keyPath:["parentEntityKey","childEntityKey"]}),g.wl(S,"byParentEntityKey","parentEntityKey"),g.wl(S,"byChildEntityKey","childEntityKey"))},version:3});return s5()},NpH=function(S){return g.Bl(Zhn(),S)},uJ=function(S){return g.Bl((0,g.SpP)(),S)},bhZ=function(S){return S instanceof
Error?new gv("UNKNOWN_ENCODE_ERROR",{originalMessage:S.message}):new gv("UNKNOWN_ENCODE_ERROR")},orN=function(S){return S instanceof Error?new gv("UNKNOWN_DECODE_ERROR",{originalMessage:S.message}):new gv("UNKNOWN_DECODE_ERROR")},rbx=function(S,W){S=S instanceof gv?S:W(S);
g.Z(S);throw S;},C4Q=function(S,W,m){try{return S.B(W,m)}catch(a){rbx(a,bhZ)}},O5=function(S){S=(new TextEncoder).encode(S).subarray(0,16);
const W=new Uint8Array(16);W.set(S);return W},DUN=function(S){const W=cb9[S];
if(W)return W;g.IL(new g.VP("Entity model not found.",{entityType:S}))},Qr=function(S,W){a:{S=j5(S.N,W.version);
try{var m=S.N(W.data,W.key);break a}catch(a){rbx(a,orN)}m=void 0}return m},XV=function(S,W,m){return S.C.objectStore("EntityStore").get(W).then(a=>{if(a){if(m&&a.entityType!==m)throw Error("Incorrect entity type");
return Qr(S,a)}})},vK=function(S,W,m){return m?(m=m.map(a=>XV(S,a,W)),g.ho.all(m)):S.C.objectStore("EntityStore").index("entityType").getAll(IDBKeyRange.only(W)).then(a=>a.map(J=>Qr(S,J)))},SLH=function(S,W,m){const a=nS(W);
return HK(S,a).then(()=>wr8(S,W,m))},lJ=function(S,W,m){let a=S.B[m];
a||(a=new Set,S.B[m]=a);a.add(W)},M4=function(S,W,m){const a=nS(W),J=j5(S.N,1),B={...W};
return S.C.objectStore("EntityStore").get(a).then(E=>{if(E){if(E.entityType!==m)throw Error("Incorrect entity type");B.entityMetadata||(E=Qr(S,E),B.entityMetadata=E.entityMetadata)}}).then(()=>{const E={key:a,
entityType:m,data:C4Q(J,B,a),version:1};return g.ho.all([g.cp(S.C.objectStore("EntityStore"),E),SLH(S,B,m)])}).then(()=>{lJ(S,a,m);
return a})},U5=function(S,W,m){W=W.map(a=>M4(S,a,m));
return g.ho.all(W)},m$8=function(S,W,m){if(m.has(W))return g.ho.resolve(void 0);
m.add(W);return Ws8(S,W).then(a=>S.C.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(W)).then(()=>a)).then(a=>{let J=g.ho.resolve(void 0);
for(const B of a)J=J.then(()=>m$8(S,B,m));
return J}).then(()=>{})},LS=function(S,W,m){if(m?.aq){const J=new Set;
return m$8(S,W,J).then(()=>{const B=[];for(const E of J)B.push(LS(S,E));return g.ho.all(B).then(()=>{})})}const a=g.wy(W).entityType;
return g.ho.all([S.C.objectStore("EntityStore").delete(W),HK(S,W)]).then(()=>{lJ(S,W,a)})},HK=function(S,W){return S.C.objectStore("EntityAssociationStore").index("byParentEntityKey").delete(IDBKeyRange.only(W))},Rd=function(S,W){return g.aY(S.C.objectStore("EntityStore").index("entityType"),{query:IDBKeyRange.only(W)},m=>g.ho.all([m.delete(),
HK(S,m.cursor.primaryKey)]).then(()=>{lJ(S,m.cursor.primaryKey,W);return g.mJ(m)}))},aOZ=function(S,W,m,a){const J=j5(S.N,1);
return XV(S,W,a).then(B=>{if(B){B=g.Vs(B,m);var E={key:W,entityType:a,data:C4Q(J,B,W),version:1};return g.ho.all([g.cp(S.C.objectStore("EntityStore"),E),SLH(S,B,a)])}}).then(()=>{lJ(S,W,a);
return W})},wr8=function(S,W,m){const a=nS(W);
m=DUN(m);if(!m)return g.ho.resolve([]);W=new m(W);S=S.C.objectStore("EntityAssociationStore");m=[];for(const J of W.N())m.push(g.cp(S,{parentEntityKey:a,childEntityKey:J}));return g.ho.all(m).then(J=>J.map(B=>B[1]))},Ws8=function(S,W){const m=S.C.objectStore("EntityAssociationStore");
return m.index("byParentEntityKey").getAll(IDBKeyRange.only(W)).then(a=>{const J=[];for(const B of a)J.push(m.index("byChildEntityKey").getAll(B.childEntityKey));return g.ho.all(J)}).then(a=>{const J=[];
for(const B of a)B.length===1&&J.push(B[0].childEntityKey);return J})},j5=function(S,W=0){S=S.C[W];
if(!S)throw W=new gv("INVALID_ENCODER_VERSION",{dP:W}),g.Z(W),W;return S},JTw=function(S,W){for(const m of S.observers)m(W)},e5=async function(S,W,m){var a=await NpH(S.token);
let J;W=await g.o_(a,["EntityStore","EntityAssociationStore"],W,B=>{J=new BcZ(B,S.C);return m(J)});
J&&(a=J.B,Object.keys(a).length>0&&(S.channel.postMessage(a),JTw(S,a)));return W},xU=function(S,W,m){return e5(S,{mode:"readwrite",
rd:!0},a=>M4(a,W,m))},EMv=function(S,W){return e5(S,{mode:"readwrite",
rd:!0},m=>U5(m,W,"offlineOrchestrationActionWrapperEntity"))},iJ=function(S,W){return e5(S,{mode:"readwrite",
rd:!0},m=>LS(m,W))},zqQ=function(S){return e5(S,{mode:"readwrite",
rd:!0},W=>Rd(W,"videoPlaybackPositionEntity"))},dv=function(S,W,m){return e5(S,{mode:"readonly",
rd:!0},a=>XV(a,W,m))},Id=function(S,W,m){return e5(S,{mode:"readonly",
rd:!0},a=>vK(a,W,m))},GMn=async function(){try{const W=await g.qd();
if(W&&g.gl()&&typeof g.P_.BroadcastChannel!=="undefined"){var S=new yTp;return new YLH(W,S)}}catch(W){W instanceof Error&&g.Z(W)}},fS=function(){PK||(PK=GMn());
return PK},Ksg=function(S){S=S.options?.persistenceOption;
return S==="ENTITY_PERSISTENCE_OPTION_PERSIST"||S==="ENTITY_PERSISTENCE_OPTION_INMEMORY_AND_PERSIST"},TcN=async function(S){const W=await fS();
W&&await e5(W,"readwrite",m=>{const a={};for(const J of S){if(!J.entityKey||!Ksg(J))continue;const B=g.ZZ(J.payload);let E=void 0;J.type==="ENTITY_MUTATION_TYPE_REPLACE"&&(E=()=>M4(m,J.payload[B],B));
J.type==="ENTITY_MUTATION_TYPE_DELETE"&&(E=()=>LS(m,J.entityKey));
J.type==="ENTITY_MUTATION_TYPE_UPDATE"&&(E=()=>aOZ(m,J.entityKey,J.payload[B],B));
E&&(a[J.entityKey]=a[J.entityKey]?a[J.entityKey].then(E):E())}return g.ho.all(Object.values(a))})},kU=async function(S){!(S=S.mutations)||S.length<=0||(g.wn&&g.wn.dispatch(Ab8({type:"ENTITY_LOADED",
payload:S})),await TcN(S),S.length=0)},qLQ=function(S){return S!==void 0},p3v=function(S){var W=g.eB();
W=Object.assign({},W);S=Object.assign({},S);for(const m in W)S[m]?(W[m]!==4&&(W[m]=S[m]),delete S[m]):W[m]!==2&&(W[m]=4);Object.assign(W,S);g.IR6(W);JSON.stringify(W);return W},Fs9=async function(S){const W=await g.qd();
return W?g.o_(await g.dn(W),["index","media","captions"],{mode:"readwrite",rd:!0},m=>{const a=IDBKeyRange.bound(S+"|",S+"~");m=[m.objectStore("index").delete(a),m.objectStore("media").delete(a),m.objectStore("captions").delete(a)];return g.ho.all(m).then(()=>{})}):void 0},VZN=async function(){const S=await g.qd();
if(!S)throw g.$O("rvdfd");return g.o_(await g.dn(S),["index","media"],{mode:"readwrite",rd:!0},W=>{const m={};return g.Wl(W.objectStore("index"),{},a=>{var J=a.cursor.key.match(/^([\w\-_]+)\|(a|v)$/);let B=g.ho.resolve(void 0);if(J){const E=J[1];J=J[2];m[E]=m[E]||{};m[E][J]=g.$yD(a.getValue()?.fmts)}else B=a.delete().then(()=>{});
return g.ho.all([g.mJ(a),B]).then(([E])=>E)}).then(()=>{const a={};
for(const B of Object.keys(m)){const E=m[B].v;a[B]=m[B].a&&E?1:2}const J=p3v(a);return g.xI_(W.objectStore("media"),{},B=>{const E=B.cursor.key.match(g.ZMP);E&&a[E[1]]||W.objectStore("media").delete(B.cursor.key);return g.vi7(B)}).then(()=>J)})})},nMQ=async function(S,W){var m=await g.qd();
if(!m)throw g.$O("wct");m=await g.dn(m);await g.o_(m,["captions"],{mode:"readwrite",rd:!0},a=>{const J=[];a=a.objectStore("captions");for(let B=0;B<W.length;B++){const E=g.cp(a,W[B],S+"|"+W[B].metadata.vss_id);J.push(E)}return g.ho.all(J)})},sj8=async function(S){S=IDBKeyRange.bound(S+"|",S+"~");
const W=await g.qd();if(!W)throw g.$O("gactfv");return(await g.dn(W)).getAll("captions",S)},uzw=async function(S){g.iA(S,0);
return Fs9(S)},gMw=function(S){return{context:g.GK(),
videoIds:S}},Oex=function(S){return{context:g.GK(),
playlistIds:S}},jjw=function(S){return{context:g.GK(),
offlinePlaylistSyncChecks:S}},X38=function(){$U||($U=new Qj9);
return $U},vM8=function(S,W){return{eventType:{flowEventNamespace:"FLOW_EVENT_NAMESPACE_OFFLINE_ORCHESTRATION",
flowEventType:S},metadata:W,statusCode:void 0,csn:void 0,can:void 0}},He$=function(S,W,m){m||(m=S.C.get("FLOW_TYPE_OFFLINE_ORCHESTRATION"),m||(m=g.uf(16),S.C.set("FLOW_TYPE_OFFLINE_ORCHESTRATION",m)));
S={flowNonce:m,flowType:"FLOW_TYPE_OFFLINE_ORCHESTRATION",flowEventType:W.eventType};W.metadata&&(S.flowMetadata=W.metadata);W.statusCode!==void 0&&(S.flowEventStatus=W.statusCode);W.csn&&(S.csn=W.csn);W.can&&(S.can=W.can);g.Om("flowEvent",S,void 0)},lOv=async function(S){var W=await e5(S,{mode:"readonly",
rd:!0},q=>vK(q,"playbackData").then(V=>{var X=V.map(d=>d.transfer).filter(d=>!!d),M=V.map(d=>d.offlineVideoPolicy).filter(d=>!!d),x=V.filter(d=>!!d.key).map(d=>g.Sw(g.wy(d.key).entityId,"downloadStatusEntity"));
X=vK(q,"transfer",X);M=vK(q,"offlineVideoPolicy",M);x=vK(q,"downloadStatusEntity",x);const L=X.then(d=>{d=d.reduce((h,JG)=>{JG?.offlineVideoStreams&&h.push(...JG.offlineVideoStreams);return h},[]).filter(h=>!!h);
return vK(q,"offlineVideoStreams",d)});
return g.ho.all([X,M,L,x]).then(([d,h,JG,yP])=>[V,d,h,JG,yP])}));
S=await e5(S,{mode:"readonly",rd:!0},q=>vK(q,"mainDownloadsListEntity").then(V=>V[0]?.downloads??[]));
const [m,a,J,B,E]=W,z={},y={},Y={},G={},K={};W=[];for(var T of a)T&&(z[T.key]=T);for(const q of J)q&&(y[q.key]=q);for(const q of E)q&&(Y[q.key]=q);for(const q of B)q&&(G[q.key]=q);for(const q of S)K[q.videoItem??""]=!0,q.videoItem&&(T=g.wy(q.videoItem)?.entityId??"",W.push({externalVideoId:T}));return{offlineVideos:m.filter(q=>{if(!q||!q.key||!q.offlineVideoPolicy)return!1;q=g.wy(q.key).entityId;q=g.Sw(q,"downloadStatusEntity");return!(q&&Y[q]?.downloadState==="DOWNLOAD_STATE_USER_DELETED")}).map(q=>
{var V=z[q.transfer];
const X=[];if(V?.offlineVideoStreams)for(var M of V.offlineVideoStreams){var x=G[M];x&&X.push(x)}M=y[q.offlineVideoPolicy];x=q?.playerResponseTimestamp;var L=g.wy(M.key).entityId;q=g.Sw(L,"mainVideoEntity");if(M.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"){var d="OFFLINE_VIDEO_STATE_DISABLED";M.expirationTimestamp&&Number(M.expirationTimestamp)<Date.now()/1E3&&(d="OFFLINE_VIDEO_STATE_EXPIRED")}else if(M.action==="OFFLINE_VIDEO_POLICY_ACTION_DOWNLOAD_FAILED")d="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";
else{switch(V?.transferState){case "TRANSFER_STATE_TRANSFER_IN_QUEUE":d="OFFLINE_VIDEO_STATE_PENDING";break;case "TRANSFER_STATE_TRANSFERRING":d="OFFLINE_VIDEO_STATE_TRANSFERRING";break;case "TRANSFER_STATE_PAUSED_BY_USER":d="OFFLINE_VIDEO_STATE_PAUSED_TRANSFER";break;case "TRANSFER_STATE_FAILED":d="OFFLINE_VIDEO_STATE_OFFLINE_FAILED";break;case "TRANSFER_STATE_COMPLETE":d="OFFLINE_VIDEO_STATE_PLAYABLE";break;case "TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH":d="OFFLINE_VIDEO_STATE_STREAMS_OUT_OF_DATE";
break;default:d="OFFLINE_VIDEO_STATE_UNKNOWN"}if(d==="OFFLINE_VIDEO_STATE_OFFLINE_FAILED")switch(V?.failureReason){case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":d="OFFLINE_VIDEO_STATE_OUT_OF_STORAGE_ERROR";break;case "TRANSFER_FAILURE_REASON_STREAM_MISSING":d="OFFLINE_VIDEO_STATE_STREAMS_MISSING";break;case "TRANSFER_FAILURE_REASON_NETWORK":case "TRANSFER_FAILURE_REASON_NETWORK_LOST":d="OFFLINE_VIDEO_STATE_NETWORK_ERROR"}}L={id:L,videoState:d};
V?.cotn&&(L.cotn=V.cotn);V?.maximumDownloadQuality&&(L.selectedVideoQuality=V?.maximumDownloadQuality);V?.lastProgressTimeMs&&(L.lastProgressTimeMs=V.lastProgressTimeMs);x&&(L.playerResponseSavedTimeMs=String(Number(x)*1E3));V=String;x=0;for(const h of X)if(h.streamsProgress)for(const JG of h.streamsProgress)x+=Number(JG.numBytesDownloaded??0);L.downloadedBytes=V(x);L.selectedOfflineMode=K[q]?"OFFLINE_MODE_TYPE_AUTO_OFFLINE":"OFFLINE_NOW";M.action==="OFFLINE_VIDEO_POLICY_ACTION_DISABLE"&&(L.offlinePlaybackDisabledReason=
M.offlinePlaybackDisabledReason);return L}),
additionalOfflineClientState:{mainAppAdditionalOfflineClientState:{smartDownloadVideos:W}}}},U$$=function(){try{let m=g.tG("ytglobal.locks_");
if(m)return m;var S;if(S=navigator){var W=navigator;S="locks"in W&&!!W.locks}if(S)return g.P_.localStorage&&g.P_.localStorage.getItem("noop"),m=new MZZ,g.f6("ytglobal.locks_",m),m}catch{}},hR=function(S){if(S.includes(":"))throw Error(`Invalid user cache name: ${S}`);
return`${S}:${g.uF("CacheStorage get")}`},Ls9=async function(){return tR!==void 0?tR:tR=new Promise(async S=>{try{await AR.open("test-only"),await AR.delete("test-only")}catch(W){if(W instanceof Error&&W.name==="SecurityError"){S(!1);
return}}S("caches"in window)})},N4=async function(){if(await Ls9())return Z$||(Z$=new Rqp),Z$},bJ=function(S,W,m){g.IL(new g.VP(`Woffle: ${S}`,m?{cotn:m}:""));
W instanceof Error&&g.IL(W)},eqZ=async function(S){S=await lOv(S);
g.Om("offlineStateSnapshot",S)},od=function(S,W){g.AJ(S.api,"onOfflineOperationFailure",W);
S.C?.postMessage(W)},x$9=function(S){if(!S.B&&!S.C){var W=U$$();
if(W){S.B=!0;var m=g.uF("OfflineLockManager");W.request(`${"woffle_orchestration_leader"}:${m}`,{},async()=>{try{S.N=new g.YC,S.C=!0,S.B=!1,await S.Z(),await S.N.promise}catch(a){S.Ss(),a instanceof Error&&(a.args=[{name:"WoLockManagerError",CG:a.name}],g.Z(a))}})}}},rv=function(S){S.V&&S.W&&S.A&&S.visibility.isBackground()?S.j.Db(6E4):S.j.stop()},iex=function(S){S.C&&(S.A=!0,rv(S))},d$8=function(S,W){S.C&&(S.W=W,rv(S))},IOQ=function(S,W){S.C&&(S.V=W,rv(S))},CS=function(S){S.offlineDeleteReason=S.offlineDeleteReason??
"OFFLINE_DELETE_REASON_UNKNOWN";
S.offlineModeType=S.offlineModeType??"OFFLINE_NOW";g.Om("offlineDeleteEvent",S)},cK=function(S,{videoId:W,
rZ:m,offlineModeType:a}){S.encryptedVideoId=W;S.cotn=m?.cotn;S.offlineabilityFormatType=m?.maximumDownloadQuality;S.isRefresh=m?.isRefresh??!1;S.softErrorCount=m?.transferRetryCount??0;S.offlineModeType=a??"OFFLINE_NOW";(S.transferStatusType==="TRANSFER_STATUS_TYPE_UNKNOWN"&&S.statusType==="UNKNOWN_STATUS_TYPE"||!S.transferStatusType&&!S.statusType)&&g.IL(Error("Woffle unknown transfer status"));g.Om("offlineTransferStatusChanged",S)},PpZ=function(S,W,m,a){a={transferStatusType:"TRANSFER_STATUS_TYPE_PROCESSING",
statusType:"OFFLINING_STARTED",transferFirstStarted:!!a};W&&m&&(W=Math.floor(W/1024).toFixed(),m=Math.floor(m/1024).toFixed(),a.alreadyDownloadedKbytes=W,a.totalFetchedKbytes=W,a.totalContentKbytes=m);cK(a,S)},fOp=function(S){cK({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_USER_PAUSE",
statusType:"SUSPENDED"},S)},kMv=function(S){switch(S){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":return"OFFLINE_DATABASE_ERROR";
case "TRANSFER_FAILURE_REASON_PLAYABILITY":return"NOT_PLAYABLE";case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":return"TOO_MANY_RETRIES";case "TRANSFER_FAILURE_REASON_INTERNAL":return"OFFLINE_DOWNLOAD_CONTROLLER_ERROR";case "TRANSFER_FAILURE_REASON_STREAM_MISSING":return"STREAM_VERIFICATION_FAILED";case "TRANSFER_FAILURE_REASON_SERVER":case "TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING":return"OFFLINE_REQUEST_FAILURE";case "TRANSFER_FAILURE_REASON_NETWORK":return"OFFLINE_NETWORK_ERROR";default:return"UNKNOWN_FAILURE_REASON"}},
D$=function(S){return(S.actionMetadata?.retryScheduleIntervalsInSeconds?.length??0)>0},wv=function(S){return S.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD"&&!!S.entityKey},SQ=function(S){return S.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&!!S.entityKey},WN=function(S){return S.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&!!S.entityKey},$$p=function(S){return S.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE"&&!!S.entityKey},mP=async function(S,W,m,a,J=!1){const B=
g.Sw(S,W),E=g.Sw(S,"downloadStatusEntity");
S=await e5(m,{mode:"readonly",rd:!0},y=>g.ho.all([XV(y,B,W),XV(y,E,"downloadStatusEntity")]));
const z=S.length?S[0]:void 0;if(z){let y=S.length>1?S[1]:void 0;if(y){if(y.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&!J)return;y.downloadState=a}else y={key:E,downloadState:a};g.hj(z,hq9,y);await e5(m,{mode:"readwrite",rd:!0},Y=>g.ho.all([M4(Y,z,W),M4(Y,y,"downloadStatusEntity")]))}},a8=function(S,W){return S.actionType===W.actionType&&S.entityKey===W.entityKey},Jl=function(S,W){if(S&&S.transferState!=="TRANSFER_STATE_COMPLETE"&&S.transferState!=="TRANSFER_STATE_FAILED"){const m=g.wy(S.key).entityId;
cK({transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_BY_USER",statusType:"CANCELLED"},{videoId:m,rZ:S,offlineModeType:W})}},BN=function(S){if(!S||!S.thumbnails)return[];
const W=[];for(const m of S.thumbnails)m.url&&W.push(m.url);return W},E3=async function(S,W,m=[]){if(!m.length)return[];
W=await Id(S,W);S=new Set;for(var a of W)if(W=a.id||a.key)W=g.wy(W).entityId,S.add(W);a=[];for(const J of m)m=J.offlineVideoData,m?.videoId&&!S.has(m.videoId)&&a.push(J);return a},zv=function(S,W,m){return new g.Ky(S,{cotn:W,
raw_player_response:m,download_media:!0,start:Infinity,disable_watch_next:!0})},y8=function(){return{priority:1,
retryScheduleIntervalsInSeconds:[1,2,4]}},Gv=function(S){if(!S.key)throw Error("Entity key is required.");
if(!S.actionProto)throw Error("OfflineOrchestrationAction is required.");const W=g.wy(S.key),m=g.wy(S.actionProto.entityKey);return new Yx(m.entityType,W.entityId,S.actionProto,S.parentActionId,S.rootActionId,S.childActionIds,S.prereqActionId,S.postreqActionIds,S.retryScheduleIndex,S.hasChildActionFailed,Number(S.enqueueTimeSec)*1E3)},K4=function(S){return{key:g.Sw(S.actionId,"offlineOrchestrationActionWrapperEntity"),
actionProto:S.action,parentActionId:S.parentActionId,rootActionId:S.rootActionId,childActionIds:S.childActionIds,prereqActionId:S.prereqActionId,postreqActionIds:S.postreqActionIds,retryScheduleIndex:S.retryScheduleIndex,hasChildActionFailed:S.hasChildActionFailed,enqueueTimeSec:(S.C/1E3).toFixed()}},tZv=async function(){const S=await N4();
return S?S.delete("yt-player-local-img"):!0},Tv=async function(S){const W=await N4();
if(!W)throw Error("Cache API not supported");if(S.length){var m=await W.open("yt-player-local-img");await Promise.all(S.map(a=>m.delete(a)))}},qf=async function(S){const W=await N4();
if(!W)throw Error("Cache API not supported");S.length&&await (await W.open("yt-player-local-img")).addAll(S)},p4=async function(S,W,m,a,J){const B=g.Sw(S,"mainVideoEntity"),E=g.Sw(S,"ytMainChannelEntity"),z=g.Sw(S,"transfer"),y=g.Sw(S,"videoDownloadContextEntity");
var Y=await e5(W,{mode:"readonly",rd:!0},d=>g.ho.all([XV(d,B,"mainVideoEntity"),XV(d,E,"ytMainChannelEntity"),XV(d,z,"transfer"),XV(d,y,"videoDownloadContextEntity"),vK(d,"ytMainChannelEntity"),vK(d,"offlineOrchestrationActionWrapperEntity")]));
const [G,K,T,q,V,X]=Y;if(G||K){Y=G?BN(G.thumbnail):[];var M=K?await AT9(K,V):[];await Tv(Y.concat(M))}const x=[],L=g.Sw(S,"downloadStatusEntity");for(const d of X)Y=g.wy(d.key).entityId,M=Gv(d),M=g.wy(M.action.entityKey).entityId,Y!==S&&M!==S||a8(m,d.actionProto)||x.push(d.key);await e5(W,{mode:"readwrite",rd:!0},d=>{const h=x.map(JG=>LS(d,JG));
h.push(LS(d,B,{aq:!0}));h.push(LS(d,L,{aq:!0}));return g.ho.all(h)});
S=q?.offlineModeType;J&&(CS(J),J.offlineModeType&&(S=J.offlineModeType));Jl(T,S);od(a,{entityKey:B,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},FU=async function(S,W,m,a){const J=g.Sw(S,"mainPlaylistEntity"),B=g.Sw(S,"ytMainChannelEntity");
var E=await e5(W,{mode:"readonly",rd:!0},d=>g.ho.all([XV(d,J,"mainPlaylistEntity"),XV(d,B,"ytMainChannelEntity"),vK(d,"mainPlaylistEntity"),vK(d,"mainDownloadsListEntity"),vK(d,"ytMainChannelEntity"),vK(d,"offlineOrchestrationActionWrapperEntity")]));
const [z,y,Y,G,K,T]=E;if(z||y){E=z?ZeQ(z):[];var q=y?await AT9(y,K):[];await Tv(E.concat(q))}E=[];q=new Map;if(z){E=await Ncv(z,Y,G);for(var V of E)q.set(V,{videoId:V,playlistId:S,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});V=await e5(W,{mode:"readonly",rd:!0},JG=>g.ho.all([vK(JG,"transfer"),vK(JG,"videoDownloadContextEntity")]));
const [d,h]=V;for(var X of d)V=g.wy(X.key).entityId,(V=q.get(V))&&X&&(V.cotn=X.cotn);for(var M of h)X=g.wy(M.key).entityId,(X=q.get(X))&&M&&(X.offlineModeType=M.offlineModeType)}const x=[];for(const d of T)M=g.wy(d.key).entityId,X=Gv(d),M!==S&&X.rootActionId!==S||a8(m,d.actionProto)||x.push(d.key);const L=g.Sw(S,"mainPlaylistEntity");await e5(W,{mode:"readwrite",rd:!0},d=>{const h=x.map(JG=>LS(d,JG));
h.push(LS(d,L,{aq:!0}));return g.ho.all(h)});
if(z&&(E.reverse(),E))for(const d of E)await p4(d,W,m,a,q.get(d))},V8=async function(S,W,m,a){const J=g.Sw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),B=new Map;
S=await e5(S,{mode:"readwrite",rd:!0},E=>{const z=vK(E,"transfer"),y=vK(E,"offlineOrchestrationActionWrapperEntity"),Y=vK(E,"videoDownloadContextEntity"),G=XV(E,J,"mainDownloadsListEntity");return g.ho.all([z,y,Y,G]).then(([K,T,q,V])=>{const X=beN.map(M=>Rd(E,M));
for(const M of T)a8(W,M.actionProto)||X.push(LS(E,M.key,{aq:!0}));V&&(V.downloads=[],X.push(M4(E,V,"mainDownloadsListEntity")));if(q)for(const M of q)T=g.wy(M.key).entityId,T=g.Sw(T,"transfer"),B.set(T,M.offlineModeType);return g.ho.all(X).then(()=>K)})});
for(const E of S){Jl(E,B.get(E.key));S=g.wy(E.key).entityId;const z={videoId:S,offlineDeleteReason:a,cotn:E.cotn,offlineModeType:B.get(E.key)};CS(z);S=g.Sw(S,"mainVideoEntity");od(m,{entityKey:S,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})}await tZv()},ZeQ=function(S,W){let m=[];
if(S.thumbnailStyleData)for(const a of S.thumbnailStyleData)m=m.concat(BN(a?.value?.collageThumbnail?.coverThumbnail));S=BN(W);return m.concat(S)},Ncv=async function(S,W,m){const a=[],J=new Set;
if(m.length)for(var B of m)if(B.downloads?.length)for(const E of B.downloads)E.videoItem&&(m=g.wy(E.videoItem).entityId,J.add(m));if(S.videos){for(const E of S.videos)B=JSON.parse(g.wy(E).entityId),B.videoId&&!J.has(B.videoId)&&a.push(B.videoId);for(const E of W)if(E.key!==S.key&&(W=E.videos))for(const z of W)W=JSON.parse(g.wy(z).entityId),W.videoId&&(W=a.indexOf(W.videoId),W!==-1&&a.splice(W,1))}return a},AT9=async function(S,W){const m=BN(S.avatar);
for(const a of W)if(a.id!==S.id)for(const J of BN(a.avatar))W=m.indexOf(J),W!==-1&&m.splice(W,1);return m},oM9=async function(S){const W=g.H(S.frameworkUpdates,n4);
S.frameworkUpdates&&W&&await kU(W)},Cpv=function(S){if(S.onResponseReceivedActions?.length&&(S=g.H(g.H(S.onResponseReceivedActions[0],rTH),g.tHl)?.actions,S?.length))return S},cTp=async function(S){if(!S)return[];
S=await dv(S,g.AE,"mainDownloadsListEntity");return S?.downloads?.length?S.downloads.map(W=>W.videoItem??""):[]},s3=async function(S,W){const m=await D$N(S,W);
m&&await e5(S,{mode:"readwrite",rd:!0},a=>{const J=[M4(a,m.mainDownloadsLibraryEntity,"mainDownloadsLibraryEntity")];m.mainDownloadsListEntity&&J.push(M4(a,m.mainDownloadsListEntity,"mainDownloadsListEntity"));return g.ho.all(J)})},D$N=async function(S,W){const m=g.Sw("main_downloads_library_id","mainDownloadsLibraryEntity"),a=g.Sw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
S=await e5(S,{mode:"readonly",rd:!0},y=>g.ho.all([XV(y,m,"mainDownloadsLibraryEntity"),XV(y,a,"mainDownloadsListEntity")]));
let [J,B]=S;S=J;let E=B;S||(S={id:m});for(const y of W)if(y===g.AE){if(S.smartDownloadsList)return;S.smartDownloadsList=y}else{var z=g.wy(y).entityType;W={};z==="mainPlaylistEntity"?W.playlistItem=y:z==="mainVideoEntity"&&(W.videoItem=y);if(!g.Sm(W)){if(E?.downloads){z=!1;for(const Y of E.downloads)if(Y.playlistItem===y||Y.videoItem===y){z=!0;break}z||E.downloads.push(W)}else E={id:a,downloads:[W]};S.downloadsList=a}}return{mainDownloadsLibraryEntity:S,mainDownloadsListEntity:E}},uu=async function(S,
W){const m=g.Sw("main_downloads_library_id","mainDownloadsLibraryEntity"),a=g.Sw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity");
var J=await e5(S,{mode:"readonly",rd:!0},y=>g.ho.all([XV(y,m,"mainDownloadsLibraryEntity"),XV(y,a,"mainDownloadsListEntity"),XV(y,g.AE,"mainDownloadsListEntity")]));
const [B,E,z]=J;if(B){if(W===g.AE&&z?.downloads)z.downloads=[];else if(E?.downloads){J=g.wy(W).entityType;for(let y=0;y<E.downloads.length;y++){const Y=E.downloads[y];if(J==="mainVideoEntity"&&Y.videoItem===W){E.downloads.splice(y,1);break}else if(J==="mainPlaylistEntity"&&Y.playlistItem===W){E.downloads.splice(y,1);break}}}await e5(S,{mode:"readwrite",rd:!0},y=>{const Y=[M4(y,B,"mainDownloadsLibraryEntity")];E&&Y.push(M4(y,E,"mainDownloadsListEntity"));z&&Y.push(M4(y,z,"mainDownloadsListEntity"));
return g.ho.all(Y)})}},g8=async function(S,W){const m=g.Sw(W,"transfer"),a=g.Sw(W,"videoDownloadContextEntity");
S=await e5(S,{mode:"readonly",rd:!0},E=>g.ho.all([XV(E,m,"transfer"),XV(E,a,"videoDownloadContextEntity")]));
const [J,B]=S;return{videoId:W,cotn:J?.cotn,offlineModeType:B?.offlineModeType}},O3=async function(S,W,m,a,J){const B=g.Sw(S,"musicTrack"),E=g.Sw(S,"transfer");
var z=await e5(W,{mode:"readonly",rd:!0},V=>g.ho.all([XV(V,B,"musicTrack"),XV(V,E,"transfer"),vK(V,"musicTrack"),vK(V,"offlineOrchestrationActionWrapperEntity")]));
const [y,Y,G,K]=z;y&&(z=await w3x(y,G),await Tv(z));const T=[];for(const V of K){z=g.wy(V.key).entityId;var q=Gv(V);q=g.wy(q.action.entityKey).entityId;z!==S&&q!==S||a8(m,V.actionProto)||T.push(V.key)}await e5(W,{mode:"readwrite",rd:!0},V=>{const X=T.map(M=>LS(V,M));
X.push(LS(V,B,{aq:!0}));return g.ho.all(X)});
Jl(Y);J&&CS(J);od(a,{entityKey:B,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"})},jQ=async function(S,W,m,a,J){const B=g.Sw(S,W),E=g.Sw("music_downloads_library_id","musicDownloadsLibraryEntity");
var z=await e5(m,{mode:"readonly",rd:!0},x=>g.ho.all([XV(x,B,W),XV(x,E,"musicDownloadsLibraryEntity"),vK(x,W),vK(x,"offlineOrchestrationActionWrapperEntity")]));
const [y,Y,G,K]=z;y&&(z=await w3x(y,G),await Tv(z));let T=[];z=new Map;if(y){T=await SyN(y,G,Y);for(var q of T){const x=g.wy(q).entityId;z.set(x,{videoId:x,playlistId:S,offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"})}q=await Id(m,"transfer");for(var V of q)q=g.wy(V.key).entityId,(q=z.get(q))&&V&&(q.cotn=V.cotn)}const X=[];for(const x of K)V=g.wy(x.key).entityId,q=Gv(x),V!==S&&q.rootActionId!==S||a8(a,x.actionProto)||X.push(x.key);const M=g.Sw(S,W);await e5(m,{mode:"readwrite",rd:!0},
x=>{const L=X.map(d=>LS(x,d));
L.push(LS(x,M,{aq:!0}));return g.ho.all(L)});
if(y&&(T.reverse(),T.length))for(const x of T)(S=g.wy(x).entityId)&&await O3(S,m,a,J,z.get(S))},Q8=async function(S,W,m){S=await e5(S,{mode:"readwrite",
rd:!0},a=>{const J=vK(a,"transfer"),B=vK(a,"offlineOrchestrationActionWrapperEntity");return g.ho.all([J,B]).then(([E,z])=>{const y=W99.map(Y=>Rd(a,Y));
for(const Y of z){z=g.wy(Y.actionProto.entityKey).entityType==="musicTrack";const G=Y.actionProto.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD";a8(W,Y.actionProto)||z&&(!z||G)||y.push(LS(a,Y.key,{aq:!0}))}return g.ho.all(y).then(()=>E)})});
for(const a of S)Jl(a),S=g.wy(a.key).entityId,CS({videoId:S,offlineDeleteReason:void 0,cotn:a.cotn}),S=g.Sw(S,"musicTrack"),od(m,{entityKey:S,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_VIDEO_DELETED"});await tZv()},mIg=function(S){let W;
for(const m of S.additionalMetadatas)m.offlineMusicVideoData&&(W=m.offlineMusicVideoData);return{id:g.Sw(S.videoId,"musicTrack"),videoId:S.videoId,title:S.title,thumbnailDetails:S.thumbnail,lengthMs:String(Number(S.lengthSeconds)*1E3),albumTitle:W?.releaseTitle,musicVideoType:W?.musicVideoType,contentRating:{explicitType:W?.explicitType},artistNames:W?.byline||W?.channelName,downloadMetadata:g.Sw(S.videoId,"musicTrackDownloadMetadataEntity")}},SyN=async function(S,W,m){const a=[],J=new Set;
if(m?.downloadedTracks?.length)for(const B of m.downloadedTracks)J.add(B);if(S.tracks){for(const B of S.tracks)J.has(B)||a.push(B);for(const B of W)if(B.id!==S.id&&(W=B.tracks))for(const E of W)W=a.indexOf(E),W!==-1&&a.splice(W,1)}return a},w3x=async function(S,W){const m=BN(S.thumbnailDetails);
for(const a of W)if(a.id!==S.id)for(const J of BN(a.thumbnailDetails))W=m.indexOf(J),W!==-1&&m.splice(W,1);return m},XU=async function(S,W){var m=g.Sw("music_downloads_library_id","musicDownloadsLibraryEntity");
let a=await dv(S,m,"musicDownloadsLibraryEntity");a||(a={id:m});m=g.wy(W).entityType;m==="musicTrack"?a.downloadedTracks?.includes(W)||(a.downloadedTracks=(a.downloadedTracks??[]).concat(W)):m==="musicPlaylist"?a.downloadedPlaylists?.includes(W)||(a.downloadedPlaylists=(a.downloadedPlaylists??[]).concat(W)):m!=="musicAlbumRelease"||a.downloadedAlbumReleases?.includes(W)||(a.downloadedAlbumReleases=(a.downloadedAlbumReleases??[]).concat(W));await xU(S,a,"musicDownloadsLibraryEntity")},vN=async function(S,
W){var m=g.Sw("music_downloads_library_id","musicDownloadsLibraryEntity");
if(m=await dv(S,m,"musicDownloadsLibraryEntity")){var a=g.wy(W).entityType;let J;a==="musicTrack"?J=m.downloadedTracks:a==="musicPlaylist"&&(J=m.downloadedPlaylists);if(J?.length)for(a=0;a<J.length;a++)if(J[a]===W){J.splice(a,1);break}await xU(S,m,"musicDownloadsLibraryEntity")}},as9=function(S){var W=S.videos;
S=[];const m=[];if(W)for(const J of W){var a=J.offlineVideoData.videoId;W=g.Sw(a,"musicTrack");a=g.Sw(a,"musicTrackDownloadMetadataEntity");S.push(W);m.push(a)}return{aj:S,Ij:m}},HN=function(S,W,m){W={track:mIg(W)};
m&&(W.playlistId=m);if(S=g.H(S.actionMetadata,JLQ))W.maximumDownloadQuality=S.maximumDownloadQuality;return{musicTrackEntityActionMetadata:W}},Ei9=async function(S){var W=g.cO();
S=gMw(S);const m=g.TK(Bsn);try{var a=await g.rF(W,S,m,void 0,{qJ:!0})}catch(J){if(J instanceof g.tE)throw a=`GetOffline network manager error: ${J.message}`,bJ(a,J),Error(a);bJ("GetOffline fetch request error",J);throw Error("GetOffline fetch request error");}W=a.errorMetadata?.status;if(!a)throw bJ("Network request failed"),Error("Network request failed");if(W!==void 0)lu(W);else if(!a.videos||!a.videos.length)throw bJ("No data"),Error("No data");return a.videos.map(J=>J.offlineVideoData)},Mf=async function(S){var W=
g.cO();
S=Oex(S);const m=g.TK(Bsn);try{var a=await g.rF(W,S,m,void 0,{qJ:!0})}catch(J){if(J instanceof g.tE)throw a=`GetOffline network manager error for playlist: ${J.message}`,bJ(a,J),Error(a);bJ("GetOffline fetch request error for playlist",J);throw Error("GetOffline fetch request error for playlist");}W=a.errorMetadata?.status;if(!a)throw bJ("Network request failed for playlist"),Error("Network request failed for playlist");if(W!==void 0)lu(W,"playlist");else if(!a.playlists||!a.playlists.length)throw bJ("No data for playlist"),
Error("No data for playlist");return a.playlists.map(J=>J.offlinePlaylistData)},yLZ=async function(S,W,m,a){const J=await fS();
if(!J)return[];var B=[];a?.length?B=a:B=await Id(J,"mainPlaylistEntity");if(!B.length)return[];a=[];const E=Date.now()/1E3;for(const G of B){var z=G.downloadState?await dv(J,G.downloadState,"mainPlaylistDownloadStateEntity"):void 0,y=(B=G?.entityMetadata)&&B.nextAutoRefreshIntervalSeconds?Number(B.nextAutoRefreshIntervalSeconds):NaN;y=Number.isNaN(y)?S:y;var Y=z?.lastSyncedTimestampMillis?Number(z?.lastSyncedTimestampMillis)/1E3:0;z=z?.addedTimestampMillis?Number(z?.addedTimestampMillis)/1E3:0;if(m||
!B||Y+y<=E){y=[];if(G.videos?.length)for(const K of G.videos)Y=JSON.parse(g.wy(K).entityId),Y.videoId&&y.push(Y.videoId);Y="0";B&&(Y=String(Number(B.offlineLastModifiedTimestampSeconds??0).toFixed()));a.push({playlistId:G.playlistId,videoIds:y,offlineLastModifiedTimestamp:Y,autoSync:W,offlineDateAddedTimestamp:String(z.toFixed())})}}return a.length?await zuw(a):[]},Yyx=async function(){var S=await fS();
if(!S)return!1;S=await Id(S,"refresh");if(!S[0]?.refreshTime)return!1;S=Number(S[0].refreshTime);const W=Date.now()/1E3;return isFinite(S)&&W>=S},K9N=async function(S,W){let m;
try{const a=await GZw(S,W);await oM9(a);m=Cpv(a)}catch(a){bJ("getAndProcessSmartDownloadsResponse request or processing error",a)}return m},Tsn=async function(S,W,m,a){const J=await fS();
if(!J)return[];var B=[];a?.length?B=a:B=await Id(J,"musicPlaylist");if(!B.length)return[];a=[];const E=Date.now()/1E3;for(const Y of B){var z=(B=Y?.entityMetadata)&&B.nextAutoRefreshIntervalSeconds?Number(B.nextAutoRefreshIntervalSeconds):NaN;const G=Number.isNaN(z)?S:z;let K=z=0;var y="DOWNLOAD_SYNC_STATE_UNKNOWN";Y.downloadMetadata&&(y=await dv(J,Y.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),z=Number(y?.addedTimestampMillis??"0")/1E3,K=Number(y?.lastModifiedTimestampMillis??"0")/1E3,
y=y?.syncState??"DOWNLOAD_SYNC_STATE_UNKNOWN");if(m||y!=="DOWNLOAD_SYNC_STATE_UP_TO_DATE"||!B||Number(B.lastSyncedTimestampSeconds??0)+G<=E){B=[];if(Y.tracks?.length)for(const T of Y.tracks)B.push(g.wy(T).entityId);a.push({playlistId:Y.playlistId,videoIds:B,offlineLastModifiedTimestamp:String(K.toFixed()),autoSync:W,offlineDateAddedTimestamp:String(z.toFixed())})}}return a.length?await zuw(a):[]},GZw=async function(S,W){var m=g.cO(),a=await fS();
let J;a&&(J=await lOv(a));a=J;S={context:g.GK(),browseId:"FEdownloads",browseRequestSupportedMetadata:{downloadsBrowseParams:{offlineFeatureSettingState:{isSdEnabled:S},offlineClientState:a,clientStateRequestData:{preferredFormatType:W}}}};W=g.TK(qyH);try{var B=await g.rF(m,S,W,void 0,{qJ:!0})}catch(E){if(E instanceof g.tE)throw B=`DPS network manager error for smart downloads: ${E.message}`,bJ(B,E),Error(B);bJ("DPS fetch request error for smart downloads",E);throw Error("DPS fetch request error for smart downloads");
}m=B.errorMetadata?.status;if(B)m!==void 0&&lu(m,"smart downloads");else throw bJ("Network request failed for smart downloads"),Error("Network request failed for smart downloads");return B},F9$=async function(S,W){var m=g.cO();
S={context:g.GK(),videoPlaybackPositionEntities:S,lastSyncTimestampUsec:W};W=g.TK(p2H);try{var a=await g.rF(m,S,W,void 0,{qJ:!0})}catch(J){if(J instanceof g.tE)throw a=`VPPS network manager error: ${J.message}`,bJ(a,J),Error(a);bJ("VPPS fetch request error",J);throw Error("VPPS fetch request error");}m=a.errorMetadata?.status;if(a)m!==void 0&&lu(m,"position sync");else throw bJ("Network request failed for position sync"),Error("Network request failed for position sync");return a},nin=async function(S,
W,m){var a=g.cO(),J=m.refreshData,B=m.isEnqueuedForExpiredStreamUrlRefetch,E=m.rK,z=m.offlineSourceData;
m=m.mediaCapabilities;S={entityKey:S};J&&(S.refreshData=J);B&&(S.isExpiredStreamUrlRefetch=B);E&&(S.downloadParameters=E);z&&(S.offlineSourceData=z);W={context:g.hJ(W),signatureTimestamp:20438,videos:[S]};m&&(W.mediaCapabilities=m);J=g.TK(VU8);try{var y=await g.rF(a,W,J,void 0,{qJ:!0})}catch(Y){if(Y instanceof g.tE)throw y=`GetPDE network manager error: ${Y.message}`,bJ(y,Y),Error(y);bJ("GetPDE fetch request error",Y);throw Error("GetPDE fetch request error");}a=y.errorMetadata?.status;if(y)a!==void 0&&
lu(a,"PDE");else throw bJ("Network request failed for PDE"),Error("Network request failed for PDE");return y},lu=function(S,W){W=W?` for ${W}`:"";
if(S===0)throw S=`Empty response body${W}`,bJ(S),Error(S);S=`Response with error${W}`;bJ(S);throw Error(S);},zuw=async function(S){var W=g.cO();
S=jjw(S);const m=g.TK(sog);try{var a=await g.rF(W,S,m,void 0,{qJ:!0})}catch(J){if(J instanceof g.tE)throw a=`offlinePlaylistSyncCheck network manager error: ${J.message}`,bJ(a,J),Error(a);bJ("offlinePlaylistSyncCheck fetch request error",J);throw Error("offlinePlaylistSyncCheck fetch request error");}W=a.errorMetadata?.status;if(!a)throw bJ("Network request failed for playlist sync"),Error("Network request failed for playlist sync");if(W!==void 0)lu(W,"playlist sync");else if(!a.offlinePlaylistSyncCheckDatas||
!a.offlinePlaylistSyncCheckDatas.length)throw bJ("No data for playlist sync"),Error("No data for playlist sync");return a.offlinePlaylistSyncCheckDatas.map(J=>J.offlinePlaylistSyncCheckData)},uPN=async function(S,W){const m=new Map;
for(const a of W)m.set(a,await S.N(a));return m},U3=function(S,W,m,a,J,B){W=g.Sw(W,m);
return{actionType:S,entityKey:W,actionMetadata:{...B,priority:a,retryScheduleIntervalsInSeconds:J}}},joN=async function(S,W){var m=W.entityKey;
const a=g.H(W.actionMetadata,L4)?.isEnqueuedForExpiredStreamUrlRefetch;try{let B=void 0;B=await gin(S,W);let E;try{{const z=g.H(W.actionMetadata,L4);var J=z?{maximumDownloadQuality:z.maximumDownloadQuality}:void 0}E=await nin(m,S.Y,{isEnqueuedForExpiredStreamUrlRefetch:a,rK:J,offlineSourceData:B})}catch(z){const y=D$(W)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";bJ("PDE handleAdd error");return R8(W,!1,void 0,
"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",y,"DOWNLOAD_STATE_FAILED")}await OWn(S,E,W);return R8(W,!0,E.orchestrationActions)}catch(B){return S="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",B instanceof g.I_&&B.type==="QUOTA_EXCEEDED"&&(S="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",m="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),bJ("PDE handleAdd error"),R8(W,!1,void 0,S,m,"DOWNLOAD_STATE_FAILED")}},
viN=async function(S,W){const m=W.entityKey,a=g.wy(m).entityId;
var J=await e5(S.C,{mode:"readonly",rd:!0},K=>{const T=XV(K,m,"playbackData"),q=XV(K,g.Sw(a,"offlineVideoPolicy"),"offlineVideoPolicy");K=XV(K,g.Sw(a,"transfer"),"transfer");return g.ho.all([T,q,K])});
const [B,E,z]=J;if(!B||!E)return R8(W,!0);J=[];var y=B?.playerResponseJson?JSON.parse(B.playerResponseJson):null;if(z&&y){var Y=Qov(S,y,z);J=await X2N(S,z)}J={lastPlayerResponseTimestampSeconds:B.playerResponseTimestamp,offlineToken:E.offlineToken,formatIds:J};y={};z?.maximumDownloadQuality&&(y.maximumDownloadQuality=z.maximumDownloadQuality);try{let K=void 0;K=await gin(S,W);try{var G=await nin(m,S.Y,{refreshData:J,rK:y,offlineSourceData:K,mediaCapabilities:Y})}catch(T){const q=D$(W)?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":
"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR";bJ("PDE handleRefresh error");return R8(W,!1,void 0,"OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED",q,"DOWNLOAD_STATE_FAILED")}await OWn(S,G,W);return R8(W,!0,G.orchestrationActions)}catch(K){return S="PDE handleRefresh error",K instanceof Error&&(S=`PDE handleRefresh error: ${K.message}`),Y="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",G="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",K instanceof g.I_&&K.type===
"QUOTA_EXCEEDED"&&(Y="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",G="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),bJ(S),R8(W,!1,void 0,Y,G,"DOWNLOAD_STATE_FAILED")}},gin=async function(S,W){W=g.wy(W.entityKey).entityId;
W=g.Sw(W,"videoDownloadContextEntity");S=await dv(S.C,W,"videoDownloadContextEntity");return S?.offlineModeType?{offlineModeType:S.offlineModeType}:void 0},R8=function(S,W,m,a,J,B){return new eQ(W?"OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS":"OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",D$(S),m,a,J,B)},OWn=async function(S,W,m){if(W.frameworkUpdates&&g.H(W.frameworkUpdates,n4)){if(g.H(W.frameworkUpdates,n4).mutations&&g.H(W.frameworkUpdates,n4).mutations.length>0&&g.H(W.frameworkUpdates,n4).mutations[0].type===
"ENTITY_MUTATION_TYPE_DELETE"){const a=g.wy(g.H(W.frameworkUpdates,n4).mutations[0].entityKey).entityId,J=await g8(S.C,a),B=g.H(m.actionMetadata,L4)?.playlistId;
B&&(J.playlistId=B);J.offlineDeleteReason="OFFLINE_DELETE_REASON_UNKNOWN";g.SB(S.Y)?await p4(a,S.C,m,S.B,J):g.CG(S.Y)&&await O3(a,S.C,m,S.B)}await kU(g.H(W.frameworkUpdates,n4))}},Qov=function(S,W,m){W=zv(S.Y,m.cotn,W);
m=g.K9(W);return g.q1O(W,m,S.Y)},X2N=async function(S,W){const m=[];
if(S=await e5(S.C,{mode:"readonly",rd:!0},a=>{const J=[],B=W.offlineVideoStreams;if(B)for(const E of B)J.push(XV(a,E,"offlineVideoStreams"));return g.ho.all(J)}))for(const a of S)if(a?.streamsProgress){S=a.streamsProgress;
for(let J=0;J<S.length;J++){const B=JSON.parse(S[J].formatStreamBytes);m.push({itag:B.itag,lmt:B.lastModified,xtags:B.xtags})}}return m},HWn=async function(S,W){W=D$(W);
S=await Id(S.C,"videoPlaybackPositionEntity");if(S.length===0)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",W);try{const m=await xx.getInstance();if(!m)throw Error("prefStorage is undefined");const a=(await m.get("psi"))?.UF??"0",J=await F9$(S,a),B={isPaused:J.watchHistoryPaused,UF:J.syncTimestampUsec};await m.set("psi",B);if(!B.isPaused){const E=g.H(J.frameworkUpdates,n4);J.frameworkUpdates&&E&&await kU(E)}}catch(m){return bJ("PPE handleRefresh error: "+(m instanceof Error?m.message:
"unknown error")),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",W,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",W)},MUx=async function(S,W){const m=D$(W),a=g.wy(W.entityKey).entityId;
try{const J=await xx.getInstance();if(!J)throw Error("prefStorage is undefined");const B=await J.get("psi"),E=g.H(W.actionMetadata,lsn);if(B?.isPaused===!1&&E?.lastPlaybackPositionSeconds){const z={key:g.Sw(a,"videoPlaybackPositionEntity"),videoId:a,lastPlaybackPositionSeconds:E.lastPlaybackPositionSeconds};await xU(S.C,z,"videoPlaybackPositionEntity")}}catch(J){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
m)},UI9=async function(S,W){const m=D$(W);
try{const a=g.wy(W.entityKey).entityId;if(a==="!*$_ALL_ENTITIES_!*$")await zqQ(S.C);else{const J=g.Sw(a,"videoPlaybackPositionEntity");await iJ(S.C,J)}}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},iu=async function(S){return uzw(S)},L9w=async function(S){return(await g.hj6(S)).filter(W=>!!W.url).map(W=>
W.url)},d8=function(S,W){var m=g.xs(W);
if(m===1||m===0)return Promise.resolve();(m=S.player?.getVideoData().videoId===W?S.player:null)&&m.stopVideo();S.B=0;return iu(W)},I8=function(S,W,m=!1,a=!0){W=typeof W==="string"?W:W.videoDetails.videoId;
if(g.xs(W)===2){var J=S.player?.getVideoData().videoId===W?S.player:null;J&&J.stopVideo();g.iA(W,2);S.B=2;m?Run(S.C):a&&eup(S.C)}},iW8=async function(S,W){const m=D$(W);
if(await dv(S.C,W.entityKey,"transfer"))return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);try{await xI9(S,W)}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},dIw=async function(S,W){const m=D$(W),a=await dv(S.C,W.entityKey,"transfer");
if(!a||a.transferState!=="TRANSFER_STATE_COMPLETE")return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);try{await xI9(S,W,!0)}catch(J){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},IsN=async function(S,W){const m=D$(W),a=g.wy(W.entityKey).entityId,J=await e5(S.C,{mode:"readonly",
rd:!0},z=>{const y=XV(z,W.entityKey,"transfer");z=XV(z,g.Sw(a,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.ho.all([y,z])}),[B,
E]=J;if(!B||B.transferState!=="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH")return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);try{B.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE";await xU(S.C,B,"transfer");const z=g.wy(B.key).entityId;cK({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_PLAYER_RESPONSE_REFRESH"},{videoId:z,rZ:B,offlineModeType:E?.offlineModeType})}catch(z){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},xI9=async function(S,W,m=!1){const a=g.H(W.actionMetadata,Plg),J=g.wy(W.entityKey).entityId,B=g.Sw(J,"downloadStatusEntity");
var E=await e5(S.C,{mode:"readonly",rd:!0},G=>{const K=XV(G,B,"downloadStatusEntity");G=XV(G,g.Sw(J,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.ho.all([K,G])});
const [z,y]=E;E="TRANSFER_STATE_TRANSFER_IN_QUEUE";z?.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&(E="TRANSFER_STATE_PAUSED_BY_USER");const Y={key:W.entityKey,transferState:E,cotn:g.uf(16),enqueuedTimestampMs:Date.now().toString(),maximumDownloadQuality:a?.maximumDownloadQuality,preferredAudioTrack:a?.preferredAudioTrack,transferRetryCount:0,isRefresh:m,hasLoggedFirstStarted:!1};await e5(S.C,{mode:"readwrite",rd:!0},G=>{const K=[];m&&K.push(LS(G,g.Sw(J,"offlineVideoStreams")));K.push(M4(G,Y,"transfer"));
return g.ho.all(K)});
m&&await iu(J);cK({transferStatusType:"TRANSFER_STATUS_TYPE_ENQUEUED",statusType:"ADDED_TO_QUEUE"},{videoId:J,rZ:Y,offlineModeType:y?.offlineModeType})},kZH=function(S,W,m,a){if(!S.action.entityKey)throw Error("entityKey is missing.");
const {po:J,entityId:B}=g.wy(S.action.entityKey),E={entityType:J,entityId:B,offlineOrchestrationActionType:S.action.actionType,orchestrationAction:{orchestrationActionId:S.actionId}};W&&(E.offlineOrchestrationActionResult=W.status,E.isRetryable=m?!1:W.C,W.B&&(E.offlineOrchestrationFailureReason=fsQ(W.B,E.isRetryable)));S.action.actionMetadata?.offlineLoggingData?.offlineModeType&&(E.offlineModeType=S.action.actionMetadata.offlineLoggingData.offlineModeType);a&&(E.additionalOrchestrationActions=a.map(z=>
({orchestrationActionId:z.actionId})));
return E},fsQ=function(S,W){return S!=="OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR"||W?S==="OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"&&W?"OFFLINE_ORCHESTRATION_FAILURE_REASON_RECOVERABLE_NETWORK_ERROR":S:"OFFLINE_ORCHESTRATION_FAILURE_REASON_UNRECOVERABLE_NETWORK_ERROR"},PN=function(S,W){const m={offlineOrchestrationContext:kZH(S)};
W=vM8(W,m);He$(X38(),W,S.rootActionId)},f4=function(S,W,m,a=[]){W={offlineOrchestrationContext:kZH(S,W,m,a)};
W=vM8(3,W);He$(X38(),W,S.rootActionId)},$Iv=function(S,W){for(const m of W)PN(m,1),S.actions.push(m);
S.actions.sort(S.C)},huQ=function(S,W){if(W)for(let m=0;m<S.actions.length;m++)if(W==="!*$_ALL_ENTITIES_!*$"&&S.actions[m].actionId!==W||W!=="!*$_ALL_ENTITIES_!*$"&&S.actions[m].rootActionId===W&&S.actions[m].actionId!==W)S.actions.splice(m,1),m--},tU9=function(S,W){for(const m of S.actions)if(m.actionId===W)return!0;
return!1},bW9=async function(S,W,m,a,J){S=new ALZ(S,W,m,a,J);
await ZW8(S);Nsg(S);return S},ZW8=async function(S){const W=await Id(S.N,"offlineOrchestrationActionWrapperEntity");
await kx(S,W)},Nsg=function(S){const W=S.C.actions[0];
return S.j?(W?.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&S.j[0].action.actionType!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(S.A=!0),Promise.resolve()):oiw(S)},oiw=async function(S){if(S.j)throw Error("Already processing an action");
if(!S.n_()){var W=S.C.actions.shift();d$8(S.iY,!W);if(W!==void 0){W.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&W.actionId==="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS"&&huQ(S.C,W.actionId);var m="";W.action.actionType==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&W.rootActionId===W.actionId&&(m=W.actionId);var a=[W];S.j=a;if(W=S.bY[W.entityType]){for(const J of a)PN(J,2);try{const J=await uPN(W,a.map(B=>B.action));
for(const B of a){const E=J.get(B.action);await rLQ(S,B,E)}huQ(S.C,m)}catch(J){bJ("Orchestration error",J);try{await ClZ(S,a)}catch(B){bJ("Orchestration retry error",B);for(const E of a)E.retryScheduleIndex<3&&$Iv(S.C,[E])}}finally{S.j=void 0}}else S.j=void 0;await oiw(S)}}},rLQ=async function(S,W,m){var a=W.retryScheduleIndex+2===3;
if(m.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS"){var J=void 0;try{J=m.j?.map(B=>S.createAction(B,W))}catch(B){f4(W,m,a);
od(S.V,{entityKey:W.action.entityKey,failureReason:"OFFLINE_OPERATION_FAILURE_REASON_UNSUPPORTED_ENTITY_FAILED"});bJ("Orchestration subactions creation error",B);return}f4(W,m,a,J);if(J){const B=J.map(z=>K4(z));
let E=0;for(;E<J.length&&!S.A;)await e5(S.N,{mode:"readwrite",rd:!0},z=>{const y=[];y.push(U5(z,B.slice(E,E+10),"offlineOrchestrationActionWrapperEntity"));return g.ho.all(y)}),E+=10;
if(S.A){S.A=!1;return}}m=K4(W);await iJ(S.N,m.key);PN(W,4)}else if(m.status==="OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE")if(f4(W,m,a),m.C&&W.retryScheduleIndex+1<3)await ClZ(S,[W]);else{a={entityKey:W.action.entityKey,failureReason:m?.N?m.N:"OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN"};J=void 0;g.SB(S.Y)?J="mainVideoDownloadStateEntity":g.CG(S.Y)&&(J="musicTrackDownloadMetadataEntity");if(J&&m.downloadState){const B=g.wy(W.action.entityKey).entityId;await mP(B,J,S.N,m.downloadState)}od(S.V,a);m.downloadState===
"DOWNLOAD_STATE_FAILED"&&S.Y.T("html5_auto_retry_failed_pde_actions")||(bJ("Orchestration result is not retryable, deleting action"),await iJ(S.N,K4(W).key))}},ClZ=async function(S,W){for(const m of W){const a=m.action?.actionMetadata?.retryScheduleIntervalsInSeconds||[1,
2,4];let J=1;m.retryScheduleIndex<a.length&&(J=a[m.retryScheduleIndex]);m.C=J*1E3+Date.now();m.retryScheduleIndex++}await cLx(S,W)},DIZ=async function(S,W){return(await Id(S.N,"offlineOrchestrationActionWrapperEntity",W)).filter(qLQ)},kx=async function(S,W){let m=[];
var a=Infinity;let J=4E3;for(const E of W){W=Number(E.enqueueTimeSec);const z=w2p(W);var B=E.retryScheduleIndex;B=B!=null&&B>0;z>0&&B?(a=Math.min(a,W),J=Math.min(z,J)):m.push(E)}isFinite(a)&&(!S.B.isActive()||a<S.Z)&&(S.Z=a,S.B.start(J));S.W.wp()||(a=m.length,m=m.filter(E=>!Slv.includes(E.actionProto?.actionType||"OFFLINE_ORCHESTRATION_ACTION_TYPE_UNKNOWN")),a=m.length<a,!S.B.isActive()&&a&&S.B.start(1));
m.length>0&&WT9(S,m);await Nsg(S)},w2p=function(S){S=S*1E3-Date.now();
return S>4E3?4E3:S},WT9=function(S,W){W.length!==0&&W.forEach(m=>{m=Gv(m);
m.retryScheduleIndex<3&&$Iv(S.C,[m])})},mRN=async function(S){var W=await DIZ(S);
const m=[];for(const a of W)W=g.wy(a.key).entityId,tU9(S.C,W)||m.push(a);await kx(S,m)},cLx=function(S,W){if(W.length===0)return Promise.resolve([]);
W=W.map(m=>K4(m));
return EMv(S.N,W)},a0Q=async function(S,W){const m=W.videoId;
let a=!0;if(W.captionTracks.length){const J=h4H(W);S.C=new g.jH(S.L_,W,J)}else if(W.yc)S.C=new g.Qh(S.L_,W.yc,m,g.BEj(W),W.V2,W.eventId),a=W.V2;else return;return new Promise(J=>{S.C?.A({jS:async()=>{await S.jS(m,a);J()},
BL:()=>{}})})},Ji9=async function(S){S=await sj8(S);
return!!S&&S.length>0},BA$=async function(S,W){if(W.length===0)return[];
const m=W.map(J=>g.Sw(J,"transfer")),a=(await Id(S.C,"transfer",m)).filter(qLQ).map(J=>g.wy(J.key).entityId);
S=W.filter(J=>a.indexOf(J)===-1);
if(S.length===0)return[];for(const J of S)await iu(J);return S},yin=async function(S,W,m,a,J,B){let E="STREAM_TYPE_UNKNOWN";
m.video&&m.audio?(E="STREAM_TYPE_AUDIO_AND_VIDEO",bJ("unexpected stream type")):m.video&&!m.audio?E="STREAM_TYPE_VIDEO":!m.video&&m.audio&&(E="STREAM_TYPE_AUDIO");const z=g.Sw(W,"offlineVideoStreams"),y={numBytesDownloaded:J.toFixed(),numTotalBytes:B.toFixed(),streamType:E,streamState:"DOWNLOAD_STREAM_STATE_IN_PROGRESS",formatStreamBytes:JSON.stringify(a),itag:E==="STREAM_TYPE_AUDIO_AND_VIDEO"?Number(m.itag):void 0};await e5(S,{mode:"readwrite",rd:!0},Y=>{const G=XV(Y,z,"offlineVideoStreams"),K=XV(Y,
g.Sw(W,"transfer"),"transfer");return g.ho.all([G,K]).then(([T,q])=>{if(!q)return LS(Y,z).then(()=>{});
var V=EVg(T);T=z5p(T,a,y,z);const X=M4(Y,T,"offlineVideoStreams");EVg(T)>V&&(q.lastProgressTimeMs=Date.now().toString());V=[X];q.offlineVideoStreams||(q.offlineVideoStreams=[]);q.offlineVideoStreams.indexOf(z)===-1&&(q.offlineVideoStreams.push(z),V.push(M4(Y,q,"transfer")));return g.ho.all(V)})})},YlQ=async function(S,W){W=g.Sw(W,"offlineVideoStreams");
if((W=await dv(S,W,"offlineVideoStreams"))&&W.streamsProgress){for(const m of W.streamsProgress)m.streamState="DOWNLOAD_STREAM_STATE_COMPLETE",m.numTotalBytes!==m.numBytesDownloaded&&(m.numBytesDownloaded=m.numTotalBytes);await xU(S,W,"offlineVideoStreams")}},z5p=function(S,W,m,a){if(S&&S.streamsProgress){a=S;
a:{W=`${W.itag};${W.xtags}`;var J=S.streamsProgress;for(let B=0;B<J.length;B++){const E=JSON.parse(J[B].formatStreamBytes);if(`${E.itag};${E.xtags}`===W){J[B]=m;m=J;break a}}J.push(m);m=J}a.streamsProgress=m}else S={key:a,streamsProgress:[m]};return S},EVg=function(S){if(S?.streamsProgress){let W=0;
S=S.streamsProgress;for(let m=0;m<S.length;m++){const a=S[m];isNaN(Number(a.numBytesDownloaded))?bJ("stream progress bytes number invalid"):W+=Number(a.numBytesDownloaded)}return W}return 0},Run=async function(S){if(S.C){const W=S.C;
S.j.stop();await $x(S,"TRANSFER_STATE_PAUSED_BY_USER");const m=W?.key?g.wy(W.key).entityId:"";m&&S.B&&await mP(m,S.B,S.N,"DOWNLOAD_STATE_PAUSED");const a=await hl(S,m);fOp({videoId:m,rZ:W,offlineModeType:a})}else tl(S,"onTransferPausedByUser");Al(S);Zx(S)},eup=async function(S){if(S.C){S.j.stop();
await $x(S,"TRANSFER_STATE_TRANSFER_IN_QUEUE");var W=S.C;(W=W?.key?g.wy(W.key).entityId:"")&&S.B&&await mP(W,S.B,S.N,"DOWNLOAD_STATE_PAUSED");Al(S)}else tl(S,"onTransferPausedByNetwork")},Nf=async function(S){if(S.C){S.j.start(108E5);
await $x(S,"TRANSFER_STATE_TRANSFERRING");var W=S.C;(W=W?.key?g.wy(W.key).entityId:"")&&S.B&&await mP(W,S.B,S.N,"DOWNLOAD_STATE_DOWNLOAD_IN_PROGRESS")}else tl(S,"onTransferStart")},Gpg=async function(S,W,m){if(S.C){S.C.transferState!=="TRANSFER_STATE_TRANSFERRING"&&await Nf(S);
var a=Date.now();a-S.q2>1E3&&(S.q2=a,await yin(S.N,m.videoId,m.N,m.ib,m.bytesDownloaded,m.C),!S.S||S.S&&a-S.iY>S.ZQ)&&(S.iY=a,a=await hl(S,W),PpZ({videoId:W,rZ:S.C,offlineModeType:a},m.bytesDownloaded,m.C));S.j.start(108E5)}else tl(S,`onTransferProgress: ${W}`)},TAZ=async function(S){if(S.C){var W=S.C;
S.j.stop();if(W&&S.A){var m=zv(S.api.K(),W.cotn,S.A);await KTx(S,m)}await $x(S,"TRANSFER_STATE_COMPLETE","DOWNLOAD_STREAM_STATE_COMPLETE");(m=W?.key?g.wy(W.key).entityId:"")&&S.B&&await mP(m,S.B,S.N,"DOWNLOAD_STATE_COMPLETE");await YlQ(S.N,m);var a=await hl(S,m);cK({transferStatusType:"TRANSFER_STATUS_TYPE_COMPLETED",statusType:"SUCCESS"},{videoId:m,rZ:W,offlineModeType:a});Al(S);Zx(S)}else tl(S,"onTransferComplete")},ql9=async function(S){await VZN();
S=S.vn;var W=g.eB();W=Object.keys(W);await BA$(S,W)},Vqv=async function(S){S=(await Id(S.N,"transfer")).filter(pe$).sort(FTn);
return S.length===0?void 0:S[0]},upp=async function(S,W){if(!S.Z){S.Z=!0;
S.C=W;var m=g.wy(S.C.key).entityId;if(S.C.transferState==="TRANSFER_STATE_TRANSFERRING"){var a=await hl(S,m);cK({transferStatusType:"TRANSFER_STATUS_TYPE_RESUME_PROCESSING",statusType:"OFFLINING_RETRIED"},{videoId:m,rZ:S.C,offlineModeType:a})}else S.C.transferState!=="TRANSFER_STATE_TRANSFER_IN_QUEUE"||S.C.transferRetryCount||S.C.hasLoggedFirstStarted||(a=await hl(S,m),S.C.hasLoggedFirstStarted=!0,await nVN(S),PpZ({videoId:m,rZ:S.C,offlineModeType:a},void 0,void 0,!0));await Nf(S);m=null;try{m=await sFv(S,
W),S.A=m}catch(J){bJ("error getting player response",J,W.cotn);await S.Ej("TRANSFER_FAILURE_REASON_SERVER_PROPERTY_MISSING");return}a=zv(S.api.K(),W.cotn,m);await KTx(S,a);a.fk=await L9w(a.videoId);m=S.V;W=W.maximumDownloadQuality;a.getPlayerResponse();g.iA(a.videoId,2);m.B=2;m.N=!1;m.player?.dispose();m.player=m.api.zv(a);m.player.XV({localmediachange:m.VE,signatureexpired:m.gF,statechange:m.j},m);m.T("html5_generate_content_po_token")&&m.player.Xh();W=m.PE(W);m.player.o1(g.Ng(W,W,!0,"m"),!1);m.player.tL(!1);
S.j.start(108E5)}},Al=function(S){S.C=void 0;
S.A=void 0;S.j.stop()},Zx=async function(S,W=!1){if(S.C)throw Error("Already downloading a video");
S.iY=0;S.Z=!1;const m=await Vqv(S);IOQ(S.Hn,!m);m&&S.W.wp()?(W&&await new Promise(a=>{g.xo(a,1E3)}),await upp(S,m)):!m&&S.C&&Al(S)},hl=async function(S,W){return(await dv(S.N,g.Sw(W,"videoDownloadContextEntity"),"videoDownloadContextEntity"))?.offlineModeType??void 0},gV9=async function(S){S.A&&(await d8(S.V,S.A.videoDetails.videoId),Al(S))},KTx=async function(S,W){try{(W.captionTracks.length||W.yc)&&!await Ji9(W.videoId)&&await a0Q(S.K_,W)}catch(m){bJ("Caption downloading error",m,W.cotn)}},nVN=
async function(S,W){if(S.C){var m=S.C;
await e5(S.N,{mode:"readwrite",rd:!0},a=>{const J=[M4(a,m,"transfer")];W&&J.push(W(a));return g.ho.all(J)})}},sFv=async function(S,W){W=g.wy(W.key).entityId;
W=g.Sw(W,"playbackData");S=await dv(S.N,W,"playbackData");if(S?.playerResponseJson)return JSON.parse(S.playerResponseJson);throw Error("No PlayerResponse found");},$x=async function(S,W,m,a){if(S.C){S.C.transferState=W;
S.C.failureReason=a;try{await nVN(S,J=>m?vK(J,"offlineVideoStreams",S.C.offlineVideoStreams).then(B=>{for(const E of B)if(E&&E.streamsProgress)for(const z of E.streamsProgress)z.streamState=m;return U5(J,B.filter(E=>!!E),"offlineVideoStreams")}):g.ho.resolve(void 0))}catch(J){J instanceof g.I_&&J.type==="QUOTA_EXCEEDED"&&await S.Ej("TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE")}}else tl(S,`saveTransferState: ${W}`)},tl=function(S,W){S.api.N2("woffle",{mcte:W});
bJ("missing current transfer entity.")},OIH=function(S){const W=(S.C.transferRetryCount||0)<3;
W&&(S=S.C,S.transferRetryCount=(S.transferRetryCount||0)+1);return W},jFv=async function(S,W="TRANSFER_FAILURE_REASON_UNKNOWN"){S.C||tl(S,`setTransferToFailed: ${W}`);
var m="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";W==="TRANSFER_FAILURE_REASON_NETWORK"?m="OFFLINE_OPERATION_FAILURE_REASON_NETWORK_REQUEST_FAILED":W==="TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE"&&(m="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED");await $x(S,"TRANSFER_STATE_FAILED","DOWNLOAD_STREAM_STATE_ERROR_STREAMS_MISSING",W);od(S.U,{entityKey:S.C?.key,failureReason:m});m=S.C?g.wy(S.C.key).entityId:"";const a=await hl(S,m);S={videoId:m,rZ:S.C,offlineModeType:a};m={transferStatusType:"TRANSFER_STATUS_TYPE_TERMINATED_WITH_FAILURE",
statusType:"FAILED"};W&&(m.transferFailureReason=W,m.failureReason=kMv(W));cK(m,S)},pe$=function(S){return bu[S.transferState]!==void 0},FTn=function(S,W){const m=bu[S.transferState],a=bu[W.transferState];
return m!==a?m-a:Number(S.enqueuedTimestampMs)-Number(W.enqueuedTimestampMs)},QFQ=async function(S){g.AJ(S.api,"onOrchestrationBecameLeader");
await S.XA()},HI8=async function(S){const W=await fS();
if(W){S.N=new XeH(W,S.api,S.B,S.C);var m=S.W(W);S.Z=await bW9(W,m,S.B,S.C,S.Y);await vVp(S)}else bJ("PES is undefined")},vVp=async function(S){if(S.N){S.N.C||await Zx(S.N);
S.Y.T("woffle_enable_main_downloads_library")&&await S.AX();S.Y.T("html5_offline_playback_position_sync")&&(await S.q2(),await S.t7(864E5));await S.refreshAllStaleEntities(43200,!0);await S.S();S.Y.T("html5_retry_downloads_for_expiration")&&await S.z5();S.iY=g.iP(()=>{S.refreshAllStaleEntities(43200,!0);S.S()},9E5);
g.j0(g.XD(),()=>S.SV());
var W=await fS();await eqZ(W);iex(S.B)}else bJ("transferManager is undefined")},l09=async function(){const S=await fS();
if(!S)return[];const W=Date.now()/1E3,m=await Id(S,"offlineVideoPolicy");for(const a of m)a.expirationTimestamp&&Number(a.expirationTimestamp)<W&&(a.action="OFFLINE_VIDEO_POLICY_ACTION_DISABLE",a.offlinePlaybackDisabledReason="OFFLINE_PLAYBACK_DISABLED_REASON_CLIENT_OFFLINE_CONTENT_EXPIRED",await xU(S,a,"offlineVideoPolicy"));return m.map(a=>a.key)},o8=async function(S,W,m,a,J){var B=await fS();
if(!B)return[];W=W.map(E=>{var z=g.Sw(E,m);z={actionType:a,entityKey:z,actionMetadata:{...y8(),...J}};a!=="OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"&&(z.actionMetadata.priority=0);E=new Yx(m,E,z);return K4(E)});
B=EMv(B,W);x$9(S.B);return B},Mqv=async function(S,W,m,a){const J=[];
for(const B of W)if(!B.upToDate&&(!m||B.shouldAutoSyncMetadata)&&B.playlistId){W={};switch(a){case "mainPlaylistEntity":W={mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:B.checkInSeconds,autoSync:m}};break;case "musicPlaylist":W={musicPlaylistEntityActionMetadata:{autoSync:m}}}(W=await o8(S,[B.playlistId],a,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",W))&&J.push(...W)}return J},UR9=async function(S,W){if(W.length){const m=y8();
g.hj(m,L4,{isEnqueuedForExpiredStreamUrlRefetch:!0});S.api.N2("qrd",{v:W.length});return o8(S,W,"playbackData","OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",m)}return[]},R5H=async function(S,W){const m=D$(W);
var a=g.wy(W.entityKey).entityId;let J=[];try{J=await LTg(S,a),S.Y.T("woffle_enable_main_downloads_library")&&J?.length&&await s3(S.C,[W.entityKey])}catch(E){return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.I_&&E.type==="QUOTA_EXCEEDED"?(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"):bJ("Playlist add error"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
m,void 0,W,a)}const B=[];S.Y.T("html5_offline_prevent_redownload_downloaded_video")&&(J=await E3(S.C,"mainVideoEntity",J));if(J?.length)for(const E of J)S=E.offlineVideoData,S?.videoId&&B.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",S.videoId,"mainVideoEntity",Number(W.actionMetadata?.priority||0)+1,r8,C4(W,S,a)));return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,B)},xR8=async function(S,W){const m=D$(W);
var a=W.entityKey,J=g.wy(a).entityId,B=[],E=!1;J==="!*$_ALL_ENTITIES_!*$"?(E=!0,B=await Id(S.C,"mainPlaylistEntity")):(a=await dv(S.C,a,"mainPlaylistEntity"))&&B.push(a);if(!B?.length)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);var z=g.H(W.actionMetadata,e5Z);a=z?.nextAutoRefreshIntervalSeconds;const y=z?.autoSync;let Y=[],G=!0;z=!0;let K=!1;if(E||y!==!1){try{Y=await yLZ(0,!!y,!0,B)}catch(X){X instanceof Error&&X.message==="No data"?J==="!*$_ALL_ENTITIES_!*$"?await V8(S.C,W,S.B,
"OFFLINE_DELETE_REASON_UNAVAILABLE"):await FU(J,S.C,W,S.B):X instanceof Error&&X.message==="Empty response body"&&bJ(X.message)}if(!Y.length||!E&&Y[0].playlistId!==J)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)}if(E){W=[];for(var T of Y)T.upToDate||y&&!T.shouldAutoSyncMetadata||!T.playlistId||W.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",T.playlistId,"mainPlaylistEntity",0,r8,{mainPlaylistEntityActionMetadata:{nextAutoRefreshIntervalSeconds:T.checkInSeconds,autoSync:y}}));
return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,W)}Y.length&&(T=Y[0],K=!!T.upToDate,y&&(G=T.shouldAutoSyncMetadata??!0,z=T.shouldAutoSyncVideos??!0,T.checkInSeconds&&(a=T.checkInSeconds)));if(K||!G)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);T=[];B=B[0];E=B.downloadState?await dv(S.C,B.downloadState,"mainPlaylistDownloadStateEntity"):void 0;E=E?.addedTimestampMillis?String(E.addedTimestampMillis):void 0;try{T=await LTg(S,J,E,a)}catch(X){if(X instanceof Error&&X.message===
"No data for playlist")await FU(J,S.C,W,S.B);else if(X instanceof Error&&X.message==="Empty response body for playlist")bJ(X.message);else return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",J="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",X instanceof g.I_&&X.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",J="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,W,J)}if(!z)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
m);S=[];a=new Map;if(T?.length)for(var q of T)z=q.offlineVideoData,z?.videoId&&a.set(z.videoId,z);q=new Map;z=[];if(B?.videos?.length)for(var V of B.videos)if(B=JSON.parse(g.wy(V).entityId).videoId)a.has(B)?(q.set(B,a.get(B)),a.delete(B)):z.push(B);V=Number(W.actionMetadata?.priority||0)+1;for(const [X,M]of a.entries())S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",X,"mainVideoEntity",V,r8,C4(W,M,J)));for(const [X,M]of q.entries())S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",X,"mainVideoEntity",
V,r8,C4(W,M,J)));for(const X of z)S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",X,"mainVideoEntity",0,r8,{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"},mainVideoEntityActionMetadata:{playlistId:J}}));return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,S)},iIn=async function(S,W){const m=D$(W);
try{const a=g.wy(W.entityKey).entityId;a==="!*$_ALL_ENTITIES_!*$"?await V8(S.C,W,S.B,W.actionMetadata?.offlineLoggingData?.offlineDeleteReason):(await FU(a,S.C,W,S.B),S.Y.T("woffle_enable_main_downloads_library")&&await uu(S.C,W.entityKey))}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",
m)},LTg=async function(S,W,m,a){W=await Mf([W]);
const {mainPlaylistEntity:J,im:B}=await dRH(S,W[0],m,a);S=ZeQ(J,B?.avatar);try{await qf(S)}catch(E){E instanceof Error&&E.message==="Failed to fetch"&&bJ(E.message)}return W[0].videos},C4=function(S,W,m){W={offlineVideoData:W,
playlistId:m};if(S=g.H(S.actionMetadata,e5Z))W.maximumDownloadQuality=S.maximumDownloadQuality;return{mainVideoEntityActionMetadata:W}},dRH=async function(S,W,m,a){const J=Date.now().toString();
m||(m=J);var B=W.videos;const E=W.playlistId,z=[],y=[];if(B)for(const T of B){B=T.offlineVideoData;if(!B||!B.videoId)throw bJ("Invalid offlineVideoData for playlist"),Error("Invalid offlineVideoData for playlist");B=B.videoId;B={id:g.Sw(JSON.stringify({videoId:B,playlistId:E}),"mainPlaylistVideoEntity"),video:g.Sw(B,"mainVideoEntity")};z.push(B);y.push(B.id)}let Y;const G={key:g.Sw(E,"mainPlaylistDownloadStateEntity"),addedTimestampMillis:m,lastSyncedTimestampMillis:J},K={key:g.Sw(E,"mainPlaylistEntity"),
playlistId:E,videos:y,title:W.title,thumbnailStyleData:I0$(W),visibility:PWZ(W),downloadState:G.key};W.channel&&(m=W.channel.offlineChannelData,Y=f0v(g.Sw(E,"ytMainChannelEntity"),m),K.channelOwner=Y.id);K?.entityMetadata?(K.entityMetadata.offlineLastModifiedTimestampSeconds=W.lastModifiedTimestamp,a&&(K.entityMetadata.nextAutoRefreshIntervalSeconds=String(a))):K&&(K.entityMetadata={nextAutoRefreshIntervalSeconds:a?String(a):void 0,offlineLastModifiedTimestampSeconds:W.lastModifiedTimestamp});try{await e5(S.C,
{mode:"readwrite",rd:!0},T=>{var q=M4(T,K,"mainPlaylistEntity");const V=M4(T,G,"mainPlaylistDownloadStateEntity");q=[q,V];for(const X of z)q.push(M4(T,X,"mainPlaylistVideoEntity"));Y&&q.push(M4(T,Y,"ytMainChannelEntity"));return g.ho.all(q)})}catch(T){throw bJ("PES failure for playlist"),Error("PES failure for playlist");
}return{mainPlaylistEntity:K,im:Y,VrU:z}},I0$=function(S){const W=[];
var m=S.videos;m&&m.length>0&&W.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_FIRST_VIDEO"),value:{collageThumbnail:{coverThumbnail:m[0].offlineVideoData.thumbnail}}});if((S=S.additionalMetadadatas)&&S.length>0)for(const a of S)switch(S=a.offlineBundleItemPlaylistData,m={collageThumbnail:{coverThumbnail:S?.coverThumbnail}},S?.style){case "BUNDLE_ITEM_STYLE_UNSPECIFIED":W.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_UNKNOWN"),value:m});break;case "BUNDLE_ITEM_STYLE_TWO_BY_TWO":W.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_TWO_BY_TWO"),
value:m});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO_AVATAR":W.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO_AVATAR"),value:m});break;case "BUNDLE_ITEM_STYLE_ONE_AND_TWO":W.push({key:Number("PLAYLIST_THUMBNAIL_STYLE_ONE_AND_TWO"),value:m})}return W},PWZ=function(S){switch(S.privacy){case "PRIVATE":return"PLAYLIST_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_VISIBILITY_UNLISTED";default:return"PLAYLIST_VISIBILITY_UNKNOWN"}},f0v=function(S,W){return{id:S,
channelId:W.channelId,title:W.title,avatar:W.thumbnail}},h5H=async function(S,W){const m=D$(W);
var a=g.wy(W.entityKey).entityId;const J=g.H(W.actionMetadata,cN),B=!J?.playlistId;try{await kpx(S,a,void 0,J?.offlineVideoData,B)}catch(E){return a="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.I_&&E.type==="QUOTA_EXCEEDED"&&(a="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,a,W)}S=Number(W.actionMetadata?.priority||
0)+1;W=(W=g.H(W.actionMetadata,cN))?{playbackDataActionMetadata:{maximumDownloadQuality:W.maximumDownloadQuality}}:void 0;a=U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",a,"playbackData",S,$RN,W);return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,[a])},tqn=async function(S,W){const m=D$(W),a=g.wy(W.entityKey).entityId;
var J=await dv(S.C,W.entityKey,"mainVideoEntity"),B=J?await dv(S.C,J.downloadState,"mainVideoDownloadStateEntity"):void 0;if(!J||!B)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);let E;try{await kpx(S,a,B.addedTimestampMillis,g.H(W.actionMetadata,cN)?.offlineVideoData),J=1,J=Number(W.actionMetadata?.priority||0)+1,E=U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",a,"playbackData",J,$RN)}catch(z){if(z instanceof Error&&z.message==="No data"){J=await g8(S.C,a);if(B=g.H(W.actionMetadata,
cN)?.playlistId)J.playlistId=B;J.offlineDeleteReason="OFFLINE_DELETE_REASON_UNAVAILABLE";await p4(a,S.C,W,S.B,J)}else if(z instanceof Error&&z.message==="Empty response body")bJ(z.message);else return S="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",z instanceof g.I_&&z.type==="QUOTA_EXCEEDED"&&(S="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",
m,void 0,S,W)}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,E?[E]:void 0)},AiN=async function(S,W){const m=D$(W);
try{const a=g.wy(W.entityKey).entityId;if(a==="!*$_ALL_ENTITIES_!*$")await V8(S.C,W,S.B,W.actionMetadata?.offlineLoggingData?.offlineDeleteReason);else{const J=await g8(S.C,a),B=g.H(W.actionMetadata,cN)?.playlistId;B&&(J.playlistId=B);J.offlineDeleteReason=W.actionMetadata?.offlineLoggingData?.offlineDeleteReason;await p4(a,S.C,W,S.B,J);S.Y.T("woffle_enable_main_downloads_library")&&await uu(S.C,W.entityKey)}}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
"OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},kpx=async function(S,W,m,a,J){a||(a=(await Ei9([W]))[0]);
const {mainVideoEntity:B,channelEntity:E}=await ZI9(S,a,m,J);try{const z=BN(B.thumbnail),y=BN(E.avatar);await qf(z.concat(y))}catch(z){z instanceof Error&&z.message==="Failed to fetch"&&bJ(z.message)}},ZI9=async function(S,W,m,a){m||(m=Date.now().toString());
const J=W.channel?.offlineChannelData,B={id:g.Sw(W.videoId,"ytMainChannelEntity"),channelId:J.channelId,title:J.title,avatar:J.thumbnail},E={key:g.Sw(W.videoId,"mainVideoDownloadStateEntity"),playbackData:g.Sw(W.videoId,"playbackData"),addedTimestampMillis:m,videoDownloadContextEntity:g.Sw(W.videoId,"videoDownloadContextEntity")},z={key:g.Sw(W.videoId,"videoPlaybackPositionEntity"),videoId:W.videoId,lastPlaybackPositionSeconds:"0"};let y;S.Y.T("html5_offline_playback_position_sync")&&(y={playbackPosition:z.key});
m=g.Sw(W.videoId,"mainVideoEntity");const Y={key:m,videoId:W.videoId,title:W.title,thumbnail:W.thumbnail,localizedStrings:{viewCount:W.shortViewCountText},userState:y,lengthSeconds:W.lengthSeconds?Number(W.lengthSeconds):void 0,publishedTimestampMillis:W.publishedTimestamp?(Number(W.publishedTimestamp)*1E3).toString():void 0,formattedDescription:W.description,owner:B.id,downloadState:E.key};let G,K;S.Y.T("woffle_enable_main_downloads_library")&&a&&(a=await D$N(S.C,[m]))&&(G=a.mainDownloadsLibraryEntity,
K=a.mainDownloadsListEntity);let T;T={key:g.Sw(W.videoId,"downloadStatusEntity"),downloadState:"DOWNLOAD_STATE_PENDING_DOWNLOAD"};g.hj(E,hq9,T);await e5(S.C,{mode:"readwrite",rd:!0},q=>{var V=M4(q,B,"ytMainChannelEntity"),X=M4(q,E,"mainVideoDownloadStateEntity");const M=M4(q,Y,"mainVideoEntity");V=[V,X,M];S.Y.T("html5_offline_playback_position_sync")&&(X=M4(q,z,"videoPlaybackPositionEntity"),V.push(X));G&&(X=M4(q,G,"mainDownloadsLibraryEntity"),V.push(X));K&&(X=M4(q,K,"mainDownloadsListEntity"),V.push(X));
T&&(q=M4(q,T,"downloadStatusEntity"),V.push(q));return g.ho.all(V)});
return{mainVideoEntity:Y,channelEntity:B}},bI$=async function(S,W){const m=D$(W),a=[];
var J=await xx.getInstance();let B,E;J&&(B=await J.get("sdois"),E=await J?.get("lmqf"));try{if(B===void 0)throw Error("prefStorage or opt-in state is undefined");J=[];B||(J=await cTp(S.C),J.reverse());if(J.length)for(const Y of J){if(!Y)continue;const G=g.wy(Y).entityId,K=await g8(S.C,G);K.offlineDeleteReason="OFFLINE_DELETE_REASON_PARENT_LIST_DELETE";await p4(G,S.C,{entityKey:Y,actionType:W.actionType},S.B,K)}const z=await GZw(B,E??"SD");await oM9(z);const y=Cpv(z);S.Y.T("woffle_enable_main_downloads_library")&&
(B||await uu(S.C,g.AE),await s3(S.C,[g.AE]));if(y?.length)for(const Y of y){const G=Y.actionType,K=Y.entityKey,T=Y.actionMetadata;if(G&&K&&T&&!g.H(T,NAp)){G==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(T.offlineLoggingData={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_DELETE"});const q=g.H(Y.actionMetadata,cN);q&&(q.playlistId="DOWNLOADS_LIST_ENTITY_ID_SMART_DOWNLOADS",Y.actionMetadata={...Y.actionMetadata,mainVideoEntityActionMetadata:q});a.push(Y)}}}catch(z){return S="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",
W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",z instanceof g.I_&&z.type==="QUOTA_EXCEEDED"&&(S="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,S,W)}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,a)},oVp=async function(S,W=43200,m=!0){if(!S.V.wp())return[];
let a=[];try{a=await yLZ(W,m,!1)}catch(J){J instanceof Error&&J.message==="No data"||J instanceof Error&&J.message==="Empty response body"&&bJ(J.message)}return Mqv(S,a,m,"mainPlaylistEntity")},rig=async function(S,W,m,a=!1){let J=[];
if(!await Yyx()&&!a)return[];m=await K9N(W,m);if(!m?.length)return[];W={offlineDeleteReason:"OFFLINE_DELETE_REASON_PARENT_LIST_REFRESH"};for(const E of m){m=E.actionType;var B=E.entityKey;a=E.actionMetadata;m&&B&&a&&!g.H(a,NAp)&&(m==="OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE"&&(a.offlineLoggingData=W),{entityId:B}=g.wy(B),m=await o8(S,[B],"mainVideoEntity",m,a),J=J.concat(m))}return J},ci$=async function(S,W){const m=D$(W);
var a=g.wy(W.entityKey).entityId;let J=[];try{J=await CWN(S,a),J?.length&&await XU(S.C,W.entityKey)}catch(E){return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.I_&&E.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,W,a)}const B=[];J=await E3(S.C,"musicTrack",J);if(J.length)for(const E of J)S=
E.offlineVideoData,S?.videoId&&B.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",S.videoId,"musicTrack",Number(W.actionMetadata?.priority||0)+1,Dx,HN(W,S,a)));return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,B)},DR9=async function(S,W){const m=D$(W);
var a=W.entityKey,J=g.wy(a).entityId,B=[],E=!1;J==="!*$_ALL_ENTITIES_!*$"?(E=!0,B=await Id(S.C,"musicAlbumRelease")):(a=await dv(S.C,a,"musicAlbumRelease"))&&B.push(a);if(!B?.length)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);if(E){W=[];for(var z of B){var y=g.wy(z.id).entityId;W.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",y,"musicAlbumRelease",0,Dx))}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,W)}z=[];B=B[0];E=void 0;B.downloadMetadata&&(E=await dv(S.C,
B.downloadMetadata,"musicAlbumReleaseDownloadMetadataEntity"),E=Number(E?.addedTimestampMillis??"0")/1E3);try{z=await CWN(S,J,E?.toString())}catch(K){if(K instanceof Error&&K.message==="No data")await jQ(J,"musicAlbumRelease",S.C,W,S.B);else if(K instanceof Error&&K.message==="Empty response body")bJ(K.message);else return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",y="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",K instanceof g.I_&&K.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",
y="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,W,y)}S=[];J=new Map;if(z?.length)for(var Y of z)z=Y.offlineVideoData,z?.videoId&&J.set(z.videoId,z);Y=new Map;z=[];if(B?.tracks?.length)for(var G of B.tracks)if(B=g.wy(G).entityId)J.has(B)?(Y.set(B,J.get(B)),J.delete(B)):z.push(B);G=Number(W.actionMetadata?.priority||0)+1;for(const [K,T]of J.entries())S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",K,"musicTrack",G,Dx,HN(W,T)));for(const [K,
T]of Y.entries())S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",K,"musicTrack",G,Dx,HN(W,T)));for(y of z)S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",y,"musicTrack",0,Dx));return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,S)},we$=async function(S,W){const m=D$(W);
try{const a=g.wy(W.entityKey).entityId;a==="!*$_ALL_ENTITIES_!*$"?await Q8(S.C,W,S.B):(await jQ(a,"musicAlbumRelease",S.C,W,S.B),await vN(S.C,W.entityKey))}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},CWN=async function(S,W,m){W=await Mf([W]);
S=await Sgp(S,W[0],m);S=BN(S.thumbnailDetails);await qf(S);return W[0].videos},Sgp=async function(S,W,m){var a=W.additionalMetadadatas;
let J=void 0;if(a&&a.length>0)for(var B of a)if(B.offlineMusicPlaylistData){J=B.offlineMusicPlaylistData;break}a=W.playlistId;const {aj:E,Ij:z}=as9(W);m=m?(Number(m)*1E3).toString():Date.now().toString();B=W.lastModifiedTimestamp?(Number(W.lastModifiedTimestamp)*1E3).toString():"0";const y={id:g.Sw(a,"musicAlbumReleaseDownloadMetadataEntity"),trackDownloadMetadatas:z,lastModifiedTimestampMillis:B,addedTimestampMillis:m,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},Y={id:g.Sw(a,"musicAlbumRelease"),
title:W.title,audioPlaylistId:a,trackCount:W.totalVideoCount,tracks:E,downloadMetadata:y.id};J&&(Y.thumbnailDetails=J.albumHqThumbnail??J.albumArtistThumbnail,Y.artistDisplayName=J.albumArtistDisplayName,Y.releaseDate=J.albumReleaseDate,Y.contentRating={explicitType:J.albumReleaseExplicitType},Y.releaseType=J.albumReleaseType);await e5(S.C,{mode:"readwrite",rd:!0},G=>{const K=M4(G,Y,"musicAlbumRelease");G=M4(G,y,"musicAlbumReleaseDownloadMetadataEntity");return g.ho.all([K,G])});
return Y},ms9=async function(S,W){const m=D$(W);
var a=g.wy(W.entityKey).entityId;let J=[];try{J=await Wbv(S,a),J?.length&&await XU(S.C,W.entityKey)}catch(E){return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",E instanceof g.I_&&E.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,W,a)}const B=[];J=await E3(S.C,"musicTrack",J);if(J.length)for(const E of J)S=
E.offlineVideoData,S?.videoId&&B.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",S.videoId,"musicTrack",Number(W.actionMetadata?.priority||0)+1,w8,HN(W,S,a)));return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,B)},aK$=async function(S,W){const m=D$(W);
var a=W.entityKey,J=g.wy(a).entityId,B=[],E=!1;J==="!*$_ALL_ENTITIES_!*$"?(E=!0,B=await Id(S.C,"musicPlaylist")):(a=await dv(S.C,a,"musicPlaylist"))&&B.push(a);if(!B?.length)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);const z=g.H(W.actionMetadata,JLQ)?.autoSync;let y=[],Y=!0;a=!0;let G=!1;var K=void 0;if(E||z!==!1){try{y=await Tsn(0,!!z,!0,B)}catch(M){M instanceof Error&&M.message==="No data"?J==="!*$_ALL_ENTITIES_!*$"?await Q8(S.C,W,S.B):await jQ(J,"musicPlaylist",S.C,W,S.B):M instanceof
Error&&M.message==="Empty response body"&&bJ(M.message)}if(!y.length||!E&&y[0].playlistId!==J)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)}if(E){W=[];for(var T of y)T.upToDate||z&&!T.shouldAutoSyncMetadata||!T.playlistId||W.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",T.playlistId,"musicPlaylist",0,w8,{musicPlaylistEntityActionMetadata:{autoSync:z}}));return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,W)}y.length&&(T=y[0],G=!!T.upToDate,z&&(Y=T.shouldAutoSyncMetadata??
!0,a=T.shouldAutoSyncVideos??!0,T.checkInSeconds&&(K=T.checkInSeconds)));if(G||!Y)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);T=[];B=B[0];E=void 0;B.downloadMetadata&&(E=await dv(S.C,B.downloadMetadata,"musicPlaylistDownloadMetadataEntity"),E=Number(E?.addedTimestampMillis??"0")/1E3);try{T=await Wbv(S,J,E?.toString(),K)}catch(M){if(M instanceof Error&&M.message==="No data")await jQ(J,"musicPlaylist",S.C,W,S.B);else if(M instanceof Error&&M.message==="Empty response body")bJ(M.message);
else{W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN";var q="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED";M instanceof g.I_&&M.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",q="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE");return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,W,q)}}if(!a)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);S=[];J=new Map;if(T?.length)for(var V of T)a=V.offlineVideoData,a?.videoId&&
J.set(a.videoId,a);V=new Map;a=[];if(B?.tracks?.length)for(var X of B.tracks)if(K=g.wy(X).entityId)J.has(K)?(V.set(K,J.get(K)),J.delete(K)):a.push(K);X=Number(W.actionMetadata?.priority||0)+1;for(const [M,x]of J.entries())S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",M,"musicTrack",X,w8,HN(W,x)));for(const [M,x]of V.entries())S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",M,"musicTrack",X,w8,HN(W,x)));for(q of a)S.push(U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",q,"musicTrack",0,w8));
return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,S)},J0Z=async function(S,W){const m=D$(W);
try{const a=g.wy(W.entityKey).entityId;a==="!*$_ALL_ENTITIES_!*$"?await Q8(S.C,W,S.B):(await jQ(a,"musicPlaylist",S.C,W,S.B),await vN(S.C,W.entityKey))}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},Wbv=async function(S,W,m,a){W=await Mf([W]);
S=await Bx$(S,W[0],m,a);S=BN(S.thumbnailDetails);await qf(S);return W[0].videos},Bx$=async function(S,W,m,a){const J=W.playlistId,{aj:B,
Ij:E}=as9(W);m=m?(Number(m)*1E3).toString():Date.now().toString();const z=W.lastModifiedTimestamp?(Number(W.lastModifiedTimestamp)*1E3).toString():"0",y={id:g.Sw(J,"musicPlaylistDownloadMetadataEntity"),trackDownloadMetadatas:E,lastModifiedTimestampMillis:z,addedTimestampMillis:m,syncState:"DOWNLOAD_SYNC_STATE_UP_TO_DATE"},Y={id:g.Sw(J,"musicPlaylist"),title:W.title,playlistId:J,thumbnailDetails:W.thumbnail,visibility:EJv(W),trackCount:W.totalVideoCount,tracks:B,downloadMetadata:y.id};a&&(Y?.entityMetadata?
Y.entityMetadata.nextAutoRefreshIntervalSeconds=String(a):Y&&(Y.entityMetadata={nextAutoRefreshIntervalSeconds:String(a)}));await e5(S.C,{mode:"readwrite",rd:!0},G=>{const K=M4(G,Y,"musicPlaylist");G=M4(G,y,"musicPlaylistDownloadMetadataEntity");return g.ho.all([K,G])});
return Y},EJv=function(S){switch(S.privacy){case "PRIVATE":return"PLAYLIST_ENTITY_VISIBILITY_PRIVATE";
case "PUBLIC":return"PLAYLIST_ENTITY_VISIBILITY_PUBLIC";case "UNLISTED":return"PLAYLIST_ENTITY_VISIBILITY_UNLISTED";default:return"PLAYLIST_ENTITY_VISIBILITY_UNKNOWN"}},YgH=async function(S,W){const m=D$(W);
var a=g.wy(W.entityKey).entityId;const J=g.H(W.actionMetadata,SW);try{await zIx(S,a,void 0,J?.track,J?.albumRelease),J?.playlistId||await XU(S.C,W.entityKey)}catch(B){return W="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",B instanceof g.I_&&B.type==="QUOTA_EXCEEDED"&&(W="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",a="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,
void 0,W,a)}S=(S=g.H(W.actionMetadata,SW))?{playbackDataActionMetadata:{maximumDownloadQuality:S.maximumDownloadQuality}}:void 0;W=U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",a,"playbackData",Number(W.actionMetadata?.priority||0)+1,y09,S);return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,[W])},GnQ=async function(S,W){const m=D$(W),a=g.wy(W.entityKey).entityId;
var J=await dv(S.C,W.entityKey,"musicTrack");const B=J?await dv(S.C,J.downloadMetadata,"musicTrackDownloadMetadataEntity"):void 0;if(!J||!B)return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m);let E;J=g.H(W.actionMetadata,SW);try{await zIx(S,a,B.addedTimestampMillis,J?.track,J?.albumRelease),E=U3("OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH",a,"playbackData",Number(W.actionMetadata?.priority||0)+1,y09)}catch(z){if(z instanceof Error&&z.message==="No data")await O3(a,S.C,W,S.B);else if(z instanceof
Error&&z.message==="Empty response body")bJ(z.message);else return S="OFFLINE_OPERATION_FAILURE_REASON_UNKNOWN",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED",z instanceof g.I_&&z.type==="QUOTA_EXCEEDED"&&(S="OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED",W="OFFLINE_ORCHESTRATION_FAILURE_REASON_NO_STORAGE"),new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,S,W)}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m,E?[E]:void 0)},KbQ=async function(S,
W){const m=D$(W);
try{const a=g.wy(W.entityKey).entityId;a==="!*$_ALL_ENTITIES_!*$"?await Q8(S.C,W,S.B):(await O3(a,S.C,W,S.B),await vN(S.C,W.entityKey))}catch(a){return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_FAILURE",m,void 0,"OFFLINE_OPERATION_FAILURE_REASON_DATABASE_REQUEST_FAILED","OFFLINE_ORCHESTRATION_FAILURE_REASON_DATABASE_OPERATION_FAILED")}return new eQ("OFFLINE_ORCHESTRATION_ACTION_RESULT_SUCCESS",m)},zIx=async function(S,W,m,a,J){a||(a=(await Ei9([W]))[0],a=mIg(a));
const {musicTrackEntity:B,Lb:E}=await Txn(S,a,W,J,m);S=BN(B.thumbnailDetails);W=[];E&&(W=BN(E.thumbnailDetails));await qf(S.concat(W))},Txn=async function(S,W,m,a,J){J||(J=Date.now().toString());
const B={id:g.Sw(m,"musicTrackDownloadMetadataEntity"),playbackData:g.Sw(m,"playbackData"),addedTimestampMillis:J,videoDownloadContextEntity:g.Sw(m,"videoDownloadContextEntity")};a&&(W.albumRelease=a.id);await e5(S.C,{mode:"readwrite",rd:!0},E=>{const z=[];var y=M4(E,B,"musicTrackDownloadMetadataEntity");z.push(y);y=M4(E,W,"musicTrack");z.push(y);a&&(E=M4(E,a,"musicAlbumRelease"),z.push(E));return g.ho.all(z)});
await mP(m,"musicTrackDownloadMetadataEntity",S.C,"DOWNLOAD_STATE_PENDING_DOWNLOAD");return{musicTrackEntity:W,Lb:a}},qgQ=async function(S,W=43200,m=!0){if(!S.V.wp())return[];
let a=[];try{a=await Tsn(W,m,!1)}catch(J){}return Mqv(S,a,m,"musicPlaylist")},pj9=function(S){let W;
S=g.H(S.getWatchNextResponse()?.currentVideoEndpoint,g.om);S?.playlistId&&(W=S.playlistId);return W},Fbg=async function(S,W){const m=W.clientPlaybackNonce,a={cpn:m,
offlineSourceVisualElement:g.Qj(W.bY||"").getAsJson(),selectedOfflineMode:"OFFLINE_NOW",isPartialPlayback:!1};W.N&&(a.videoFmt=Number(W.N.itag));W.j&&(a.audioFmt=Number(W.j.itag));const J=pj9(W);var B;if(B=J&&W.videoId)W=W.videoId,B=await (J!=="PPSV"?Promise.resolve(!1):S.C.vn(W));B&&(a.selectedOfflineMode="OFFLINE_MODE_TYPE_AUTO_OFFLINE");S.N=m;g.Om("offlinePlaybackStarted",a)};
g.c5.prototype.zv=g.lc(42,function(S){return this.app.zv(S)});
g.I0.prototype.zv=g.lc(41,function(S){return g.YTO(this,9,S)});
var W7=class{constructor(S){this.C=S}},mS=class extends W7{get entityMetadata(){return this.C.entityMetadata}set entityMetadata(S){this.C.entityMetadata=S}},Vxg=class extends W7{N(){const S=[];this.C.video&&S.push(this.C.video);return[...(new Set(S))]}},nJN=class extends W7{N(){const S=[];this.C.video&&S.push(this.C.video);this.C.playlist&&S.push(this.C.playlist);this.C.videoItem&&S.push(this.C.videoItem);this.C.playlistItem&&S.push(this.C.playlistItem);return[...(new Set(S))]}},svp=class extends W7{N(){const S=
[];this.C.localImageEntities&&S.push(...this.C.localImageEntities);this.C.videoDownloadContextEntity&&S.push(this.C.videoDownloadContextEntity);return[...(new Set(S))]}},ud9=class extends W7{N(){const S=[];this.C.recommendedVideoMetadata&&S.push(...(new svp(this.C.recommendedVideoMetadata)).N());return[...(new Set(S))]}},gJZ=class extends W7{N(){const S=[];this.C.playbackPosition&&S.push(this.C.playbackPosition);return[...(new Set(S))]}},O2n=class extends W7{N(){const S=[];this.C.creatorEntity&&S.push(this.C.creatorEntity);
return[...(new Set(S))]}},qyH=["browse","music/browse","streaming_browse","unplugged/browse"],sog=["offline/playlist_sync_check"],Bsn=["offline"],p2H=["offline/offline_video_playback_position_sync"],VU8=["offline/get_playback_data_entity"],s5,xx=class{constructor(S){this.token=S}static async getInstance(){return new Promise(S=>{g.qd().then(W=>{W?(xx.instance||(xx.instance=new xx(W)),S(xx.instance)):S(void 0)})})}async get(S){if(S=await (await uJ(this.token)).get("prefs",S)){var W=(0,g.t)();
return S.expirationTimestampMs<=W?void 0:S.value}}async set(S,W,m=31536E3){const a=(0,g.t)();S={key:S,value:W,expirationTimestampMs:a+m*1E3};W=await uJ(this.token);await g.Dz(W,"prefs",S)}async remove(S){await (await uJ(this.token)).delete("prefs",S)}},jvv={INVALID_ENCODER_VERSION:"Invalid encoder version",KEY_CREATION_FAILED:"Failed to create encoder key",UNKNOWN_DECODE_ERROR:"Failed to decode PES data",UNKNOWN_ENCODE_ERROR:"Failed to encode PES data",WRONG_DATA_TYPE:"Encoder cannot process the data type"},
gv=class extends g.VP{constructor(S,W={}){super(jvv[S],{name:"PESEncoderError",type:S,...W});this.type=S;this.level="WARNING";Object.setPrototypeOf(this,gv.prototype)}},QvN=class{},Xjw=class extends QvN{constructor(S){super();this.C=S}B(S,W){W=O5(W);S=(new TextEncoder).encode(JSON.stringify(S));return this.C.encrypt(S,W)}N(S,W){if(!(S instanceof Uint8Array))throw new gv("WRONG_DATA_TYPE",{dP:1});const m=new TextDecoder;W=O5(W);S=this.C.decrypt(S,W);return JSON.parse(m.decode(S))}},cb9={accountLinkStatusEntity:class extends mS{N(){return[]}},
booleanEntity:class extends mS{N(){return[]}},buttonEntity:class extends mS{N(){return[]}},captionTrack:class extends mS{N(){return[]}},channelHandle:class extends mS{N(){return[]}},chipEntity:class extends mS{N(){return[]}},commerceAcquisitionClientPayloadEntity:class extends mS{N(){return[]}},commerceCartListEntity:class extends mS{N(){return[]}},compositeSourceEntity:class extends mS{N(){return[]}},multiviewStagingEntity:class extends mS{N(){const S=[];this.C.compositeSourceKeys&&S.push(...this.C.compositeSourceKeys);
return[...(new Set(S))]}},contextNoteFeedEntityPayload:class extends mS{N(){return[]}},contextNoteUserRatingEntityPayload:class extends mS{N(){return[]}},continuationTokenEntity:class extends mS{N(){return[]}},downloadQualityPickerEntity:class extends mS{N(){return[]}},downloadsPageRefreshTokenEntity:class extends mS{N(){return[]}},downloadsPageViewConfigurationEntity:class extends mS{N(){return[]}},downloadStatusEntity:class extends mS{N(){return[]}},dismissState:class extends mS{N(){return[]}},
sfvAudioItemCurrentlyPlayingEntity:class extends mS{N(){return[]}},emojiFountainDataEntity:class extends mS{N(){return[]}},emojiCustomizationSetEntity:class extends mS{N(){return[]}},fakeChannel:class extends mS{N(){const S=[];this.C.alternateChannel&&S.push(this.C.alternateChannel);this.C.alternateChannelList&&S.push(...this.C.alternateChannelList);this.C.oneofChannelEntity&&S.push(this.C.oneofChannelEntity);return[...(new Set(S))]}},fakePlaylist:class extends mS{N(){const S=[];this.C.entryCollection&&
S.push(this.C.entryCollection);return[...(new Set(S))]}},fakePlaylistEntryCollection:class extends mS{N(){const S=[];this.C.parentPlaylist&&S.push(this.C.parentPlaylist);if(this.C.entries)for(const W of this.C.entries)S.push(...(new Vxg(W)).N());return[...(new Set(S))]}},fakeVideo:class extends mS{N(){const S=[];this.C.descriptionEntity&&S.push(this.C.descriptionEntity);this.C.creators&&S.push(...this.C.creators);this.C.theBiggestFan&&S.push(this.C.theBiggestFan);return[...(new Set(S))]}},fakeVideoDescription:class extends mS{N(){return[]}},
featuredProductsEntity:class extends mS{N(){return[]}},flowStateEntity:class extends mS{N(){return[]}},iconBadgeEntity:class extends mS{N(){return[]}},interstitialInteractionStateEntity:class extends mS{N(){return[]}},likeButtonAnimationEntity:class extends mS{N(){return[]}},liveChatPollStateEntity:class extends mS{N(){return[]}},dataFreshnessEntity:class extends mS{N(){return[]}},liveViewerLeaderboardChatEntryPointStateEntity:class extends mS{N(){return[]}},liveViewerLeaderboardPointsEntity:class extends mS{N(){return[]}},
liveReactionsDataEntity:class extends mS{N(){return[]}},logoEntity:class extends mS{N(){return[]}},macroMarkerEntity:class extends mS{N(){return[]}},mainDownloadsLibraryEntity:class extends mS{N(){const S=[];this.C.downloadsList&&S.push(this.C.downloadsList);this.C.smartDownloadsList&&S.push(this.C.smartDownloadsList);this.C.recommendedDownloadsList&&S.push(this.C.recommendedDownloadsList);this.C.refresh&&S.push(this.C.refresh);return[...(new Set(S))]}},mainDownloadsListEntity:class extends mS{N(){const S=
[];this.C.refresh&&S.push(this.C.refresh);if(this.C.downloads)for(const W of this.C.downloads)S.push(...(new nJN(W)).N());return[...(new Set(S))]}},mainPlaylistDownloadStateEntity:class extends mS{N(){const S=[];this.C.localImageEntities&&S.push(...this.C.localImageEntities);return[...(new Set(S))]}},mainPlaylistEntity:class extends mS{N(){const S=[];this.C.channelOwner&&S.push(this.C.channelOwner);this.C.videos&&S.push(...this.C.videos);this.C.collaboratorChannels&&S.push(...this.C.collaboratorChannels);
this.C.downloadState&&S.push(this.C.downloadState);this.C.refresh&&S.push(this.C.refresh);return[...(new Set(S))]}},mainPlaylistVideoEntity:class extends mS{N(){const S=[];this.C.video&&S.push(this.C.video);this.C.channelContributor&&S.push(this.C.channelContributor);return[...(new Set(S))]}},mainVideoDownloadStateEntity:class extends mS{N(){const S=[];this.C.playbackData&&S.push(this.C.playbackData);this.C.localImageEntities&&S.push(...this.C.localImageEntities);this.C.videoDownloadContextEntity&&
S.push(this.C.videoDownloadContextEntity);return[...(new Set(S))]}},mainVideoEntity:class extends mS{N(){const S=[];this.C.owner&&S.push(this.C.owner);this.C.downloadState&&S.push(this.C.downloadState);this.C.userState&&S.push(...(new gJZ(this.C.userState)).N());this.C.additionalMetadata&&S.push(...(new ud9(this.C.additionalMetadata)).N());return[...(new Set(S))]}},markersEngagementPanelSyncEntity:class extends mS{N(){return[]}},markersVisibilityOverrideEntity:class extends mS{N(){return[]}},musicAlbumReleaseDetail:class extends mS{N(){const S=
[];this.C.albumRelease&&S.push(this.C.albumRelease);this.C.tracks&&S.push(...this.C.tracks);return[...(new Set(S))]}},musicAlbumReleaseDownloadMetadataEntity:class extends mS{N(){const S=[];this.C.trackDownloadMetadatas&&S.push(...this.C.trackDownloadMetadatas);return[...(new Set(S))]}},musicAlbumRelease:class extends mS{N(){const S=[];this.C.musicLibraryStatusEntity&&S.push(this.C.musicLibraryStatusEntity);this.C.primaryArtists&&S.push(...this.C.primaryArtists);this.C.details&&S.push(this.C.details);
this.C.userDetails&&S.push(this.C.userDetails);this.C.tracks&&S.push(...this.C.tracks);this.C.share&&S.push(this.C.share);this.C.downloadMetadata&&S.push(this.C.downloadMetadata);this.C.refresh&&S.push(this.C.refresh);return[...(new Set(S))]}},musicAlbumReleaseUserDetail:class extends mS{N(){const S=[];this.C.albumRelease&&S.push(this.C.albumRelease);return[...(new Set(S))]}},musicArtistDetail:class extends mS{N(){const S=[];this.C.parentArtist&&S.push(this.C.parentArtist);return[...(new Set(S))]}},
musicArtist:class extends mS{N(){const S=[];this.C.details&&S.push(this.C.details);this.C.userDetails&&S.push(this.C.userDetails);return[...(new Set(S))]}},musicArtistUserDetail:class extends mS{N(){const S=[];this.C.parentArtist&&S.push(this.C.parentArtist);return[...(new Set(S))]}},musicDownloadsLibraryEntity:class extends mS{N(){const S=[];this.C.downloadedTracks&&S.push(...this.C.downloadedTracks);this.C.smartDownloadedTracks&&S.push(...this.C.smartDownloadedTracks);this.C.downloadedEpisodes&&
S.push(...this.C.downloadedEpisodes);this.C.downloadedAlbumReleases&&S.push(...this.C.downloadedAlbumReleases);this.C.smartDownloadedAlbumReleases&&S.push(...this.C.smartDownloadedAlbumReleases);this.C.downloadedPlaylists&&S.push(...this.C.downloadedPlaylists);this.C.smartDownloadedPlaylists&&S.push(...this.C.smartDownloadedPlaylists);this.C.metadataOnlyTracks&&S.push(...this.C.metadataOnlyTracks);return[...(new Set(S))]}},musicLibraryEdit:class extends mS{N(){return[]}},musicLibraryStatusEntity:class extends mS{N(){return[]}},
musicPlaylist:class extends mS{N(){const S=[];this.C.tracks&&S.push(...this.C.tracks);this.C.refresh&&S.push(this.C.refresh);this.C.musicLibraryStatusEntity&&S.push(this.C.musicLibraryStatusEntity);this.C.details&&S.push(this.C.details);this.C.downloadMetadata&&S.push(this.C.downloadMetadata);this.C.sideloadMetadata&&S.push(this.C.sideloadMetadata);this.C.userDetails&&S.push(this.C.userDetails);this.C.entryCollection&&S.push(this.C.entryCollection);this.C.share&&S.push(this.C.share);this.C.podcastShowAdditionalMetadata&&
S.push(...(new O2n(this.C.podcastShowAdditionalMetadata)).N());return[...(new Set(S))]}},musicPlaylistDownloadMetadataEntity:class extends mS{N(){const S=[];this.C.trackDownloadMetadatas&&S.push(...this.C.trackDownloadMetadatas);return[...(new Set(S))]}},musicShare:class extends mS{N(){return[]}},musicTrackDetail:class extends mS{N(){const S=[];this.C.parentTrack&&S.push(this.C.parentTrack);return[...(new Set(S))]}},musicTrackDownloadMetadataEntity:class extends mS{N(){const S=[];this.C.playbackData&&
S.push(this.C.playbackData);this.C.localImageEntities&&S.push(...this.C.localImageEntities);this.C.videoDownloadContextEntity&&S.push(this.C.videoDownloadContextEntity);return[...(new Set(S))]}},musicTrack:class extends mS{N(){const S=[];this.C.musicLibraryStatusEntity&&S.push(this.C.musicLibraryStatusEntity);this.C.artists&&S.push(...this.C.artists);this.C.audioModeVersion&&S.push(this.C.audioModeVersion);this.C.videoModeVersion&&S.push(this.C.videoModeVersion);this.C.userDetails&&S.push(this.C.userDetails);
this.C.details&&S.push(this.C.details);this.C.albumRelease&&S.push(this.C.albumRelease);this.C.share&&S.push(this.C.share);this.C.libraryEdit&&S.push(this.C.libraryEdit);this.C.downloadMetadata&&S.push(this.C.downloadMetadata);this.C.playbackPosition&&S.push(this.C.playbackPosition);this.C.lyrics&&S.push(this.C.lyrics);return[...(new Set(S))]}},musicTrackUserDetail:class extends mS{N(){const S=[];this.C.parentTrack&&S.push(this.C.parentTrack);return[...(new Set(S))]}},offlineOrchestrationActionWrapperEntity:class extends mS{N(){return[]}},
offlineVideoPolicy:class extends mS{N(){return[]}},offlineVideoStreams:class extends mS{N(){return[]}},offlineabilityEntity:class extends mS{N(){return[]}},orchestrationWebSamplingEntity:class extends mS{N(){const S=[];this.C.fakeChildren&&S.push(...this.C.fakeChildren);return[...(new Set(S))]}},pageHeaderEntity:class extends mS{N(){return[]}},pdpStateEntity:class extends mS{N(){return[]}},pinnedProductEntity:class extends mS{N(){return[]}},playbackData:class extends mS{N(){const S=[];this.C.transfer&&
S.push(this.C.transfer);this.C.adsPlaybackData&&S.push(...this.C.adsPlaybackData);this.C.drmLicense&&S.push(this.C.drmLicense);this.C.offlineVideoPolicy&&S.push(this.C.offlineVideoPolicy);this.C.videoDownloadContextEntity&&S.push(this.C.videoDownloadContextEntity);return[...(new Set(S))]}},playerStateEntity:class extends mS{N(){return[]}},quantityIncrementerEntity:class extends mS{N(){return[]}},refresh:class extends mS{N(){return[]}},saveToPlaylistListEntity:class extends mS{N(){return[]}},selectedChipIndexEntityPayload:class extends mS{N(){return[]}},
settingEntity:class extends mS{N(){return[]}},stringEntity:class extends mS{N(){return[]}},suggestedFeedbackChipStateEntity:class extends mS{N(){return[]}},transfer:class extends mS{N(){const S=[];this.C.offlineVideoStreams&&S.push(...this.C.offlineVideoStreams);this.C.captionTrack&&S.push(...this.C.captionTrack);return[...(new Set(S))]}},trendingOfferEntity:class extends mS{N(){return[]}},videoDownloadContextEntity:class extends mS{N(){return[]}},videoOverviewAsyncDataEntity:class extends mS{N(){return[]}},
videoPlaybackPositionEntity:class extends mS{N(){return[]}},votingEntity:class extends mS{N(){return[]}},ytMainChannelEntity:class extends mS{N(){const S=[];this.C.userChannelDetails&&S.push(this.C.userChannelDetails);return[...(new Set(S))]}},youchatPendingResponseEntity:class extends mS{N(){return[]}},ytMainDownloadedVideoEntity:class extends mS{N(){const S=[];this.C.video&&S.push(this.C.video);this.C.playbackData&&S.push(this.C.playbackData);this.C.offlineVideoPolicy&&S.push(this.C.offlineVideoPolicy);
return[...(new Set(S))]}},ytMainVideoEntity:class extends mS{N(){const S=[];this.C.channelOwner&&S.push(this.C.channelOwner);this.C.playbackPosition&&S.push(this.C.playbackPosition);this.C.localImageEntities&&S.push(...this.C.localImageEntities);this.C.downloadStatus&&S.push(this.C.downloadStatus);return[...(new Set(S))]}}},BcZ=class{constructor(S,W){this.C=S;this.N=W;this.B={}}},vJZ=class extends QvN{B(S){return S}N(S){if(S instanceof Uint8Array)throw new gv("WRONG_DATA_TYPE",{dP:0});return S}},
yTp=class{constructor(){this.C={};this.C[0]=new vJZ;if(!g.fO("aes_pes_encoder_killswitch")){var S=this.C;try{const a=g.uF();var W=O5(a);var m=new Xjw(new g.Ig(W),new g.xE(W))}catch(a){throw S=a instanceof Error?new gv("KEY_CREATION_FAILED",{originalMessage:a.message}):new gv("KEY_CREATION_FAILED"),g.Z(S),S;}S[1]=m}}},YLH=class extends g.JW{constructor(S,W){super();this.token=S;this.C=W;this.observers=[];S=new g.P_.BroadcastChannel(`${"PERSISTENT_ENTITY_STORE_SYNC"}:${g.uF()}`);S.onmessage=this.N.bind(this);
this.channel=S}observe(S){this.observers.push(S);return()=>{const W=this.observers.indexOf(S);W>=0&&this.observers.splice(W,1)}}N(S){JTw(this,S.data)}j9(){this.channel.close()}},PK,rTH=new g.D("elementsCommand");var n4=new g.D("entityBatchUpdate");var hq9=new g.D("downloadStatusEntity");var e5Z=new g.D("mainPlaylistEntityActionMetadata");var cN=new g.D("mainVideoEntityActionMetadata");var JLQ=new g.D("musicPlaylistEntityActionMetadata");var SW=new g.D("musicTrackEntityActionMetadata");var NAp=new g.D("localImageEntityActionMetadata");var L4=new g.D("playbackDataActionMetadata");var Plg=new g.D("transferEntityActionMetadata");var lsn=new g.D("videoPlaybackPositionEntityActionMetadata");var Qj9=class{constructor(){this.C=new Map}},$U;new g.YC;new g.YC;var MZZ=class{constructor(){this.locks=navigator.locks}request(S,W={},m){return this.locks.request(S,W,a=>m(a))}};var AR=g.P_.caches,tR,Z$,H2N=class{open(S){return AR.open(hR(S))}has(S){return AR.has(hR(S))}delete(S){return AR.delete(hR(S))}async match(S,W){var m=await this.keys();for(const a of m)if(m=await (await this.open(a)).match(S,W))return m}},Rqp=class extends H2N{async keys(){const S=[],W=g.uF("CacheStorage keys");var m=await AR.keys();for(const a of m){m=a.indexOf(":");const {CG:J,datasyncId:B}=m===-1?{CG:a}:{CG:a.substring(0,m),datasyncId:a.substring(m+1)};B===W&&S.push(J)}return S}};var lKN=class extends g.JW{constructor(S){super();this.api=S;this.eg={mE9:()=>this.C,
IDn:()=>this.N};
typeof g.P_.BroadcastChannel!=="undefined"&&(this.C=new g.P_.BroadcastChannel(`${"PLAYER_OFFLINE_ERROR_SYNC"}:${g.uF()}`),this.C.onmessage=this.B.bind(this),this.N=new g.P_.BroadcastChannel(`${"PLAYER_OFFLINE_PAUSE_SYNC"}:${g.uF()}`),this.N.onmessage=this.j.bind(this))}B(S){g.AJ(this.api,"onOfflineOperationFailure",S.data)}j(S){this.api.publish("offlinetransferpause",S.data)}j9(){this.C?.close();this.N?.close()}};var Mx8=class{constructor(S,W,m){this.Z=S;this.S=W;this.visibility=m;this.A=this.V=this.W=this.B=this.C=!1;this.j=new g.rr(()=>{this.Ss()});
this.eg={GK:()=>this.N,
Ss:()=>{this.Ss()},
X12:()=>this.j};
this.visibility.subscribe("visibilitystatechange",()=>{this.TY()})}TY(){this.C&&rv(this)}Ss(){this.N&&this.N.resolve();
this.B=this.C=!1;this.S()}};var Slv=["OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"];var Yx=class{constructor(S,W,m,a,J=W,B,E,z,y,Y,G){this.entityType=S;this.actionId=W;this.action=m;this.parentActionId=a;this.rootActionId=J;this.childActionIds=B;this.prereqActionId=E;this.postreqActionIds=z;this.hasChildActionFailed=Y;this.retryScheduleIndex=0;this.C=G||Date.now();this.retryScheduleIndex=y||0}};var beN="captionTrack downloadStatusEntity ytMainChannelEntity mainPlaylistEntity mainPlaylistDownloadStateEntity mainPlaylistVideoEntity mainVideoEntity mainVideoDownloadStateEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity videoPlaybackPositionEntity".split(" ");var W99="downloadStatusEntity musicAlbumRelease musicDownloadsLibraryEntity musicPlaylist musicTrack musicTrackDownloadMetadataEntity offlineVideoPolicy offlineVideoStreams playbackData transfer videoDownloadContextEntity".split(" ");var aM=class{constructor(S){this.C=S}},eQ=class{constructor(S,W,m,a,J,B){this.status=S;this.C=W;this.j=m;this.N=a;this.B=J;this.downloadState=B}};var Us8=class extends aM{constructor(S,W,m){super(S);this.C=S;this.Y=W;this.B=m}N(S){return wv(S)?joN(this,S):SQ(S)?viN(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}};var LbQ=class extends aM{constructor(S,W){super(S);this.C=S;this.Y=W}N(S){return SQ(S)?HWn(this,S):$$p(S)?MUx(this,S):WN(S)?UI9(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}};var RIv=class{constructor(S,W){this.api=S;this.C=W;this.logger=new g.gz("woffle");this.N=!1;this.eg={PE:this.PE}}async j(S){if(S.state.C(128)){const W=S.state.nJ;S=W?.errorCode;S=S==="net.connect"&&W?.p8===1?"TRANSFER_FAILURE_REASON_NETWORK_LOST":S?.startsWith("net.")?"TRANSFER_FAILURE_REASON_NETWORK":"TRANSFER_FAILURE_REASON_INTERNAL";await this.Ej(this.player.getVideoData().videoId,S)}}async Ej(S,W){this.N||(this.N=!0,W==="TRANSFER_FAILURE_REASON_NETWORK_LOST"?I8(this,S,!1,!0):(await d8(this,S),
g.iA(S,4),await this.C.Ej(W)))}VE(S){S.status===2?(S.status!==this.B&&(Nf(this.C),g.iA(S.videoId,2)),S.Vz&&Gpg(this.C,S.videoId,S.Vz)):S.status===4?(d8(this,S.videoId),this.Ej(S.videoId,S.B5?"TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":"TRANSFER_FAILURE_REASON_INTERNAL")):S.status===1&&TAZ(this.C);this.B=S.status;g.AJ(this.api,"localmediachange",{videoId:S.videoId,status:S.status})}async gF(){if(!this.N){this.N=!0;var S=this.player.getVideoData().videoId;await d8(this,S);await this.C.gF()}}PE(S){switch(S){case "HD_1080":return"hd1080";
case "HD":return"hd720";case "SD":return"large";case "LD":return"tiny";default:return"hd720"}}T(S){return this.api.K().T(S)}};var eIn=class extends aM{constructor(S,W){super(S);this.C=S;this.Y=W}N(S){return wv(S)?iW8(this,S):SQ(S)?dIw(this,S):$$p(S)?IsN(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}};var xs9=class{constructor(){this.actions=[]}C(S,W){let m=S.action.actionMetadata.priority-W.action.actionMetadata.priority;m===0&&(S.C<W.C?m=-1:S.C>W.C&&(m=1));return m}};var ALZ=class extends g.JW{constructor(S,W,m,a,J){super();this.N=S;this.bY=W;this.iY=m;this.V=a;this.Y=J;this.C=new xs9;this.W=new g.qm;this.B=new g.rr(()=>{this.retry()});
this.Z=NaN;this.A=!1;this.eg={PQ2:()=>this.C,
WN:()=>this.W,
HaY:()=>this.B,
retry:()=>this.retry()};
g.R(this,this.B);this.S=this.N.observe(this.U.bind(this))}j9(){this.S&&this.S();super.j9()}createAction(S,W){const m=g.wy(S.entityKey).entityType,a=g.uf(16);return new Yx(m,a,S,W.actionId,W.rootActionId)}async U(S){if(!this.n_()){var W=S.offlineOrchestrationActionWrapperEntity??new Set;S=[];for(var m of W)({entityId:W}=g.wy(m)),tU9(this.C,W)||S.push(m);m=await DIZ(this,S);await kx(this,m)}}async retry(){await mRN(this)}};var i29=class{constructor(S){this.L_=S;this.C=void 0}async jS(S,W=!0){if(this.C){var m=[],a=g.Cf(this.C.C,W),J=[];for(let B=0;B<a.length;B++)W=this.C.W(a[B],"json3"),W=g.wa(W,{withCredentials:!0,format:"RAW"},3,500).then(E=>{E={metadata:g.nN(a[B]),trackData:E.xhr.responseText};J.push(E)}).S1(E=>{bJ("Caption fetch error",E)}),m.push(W);
await tsv(m);try{await nMQ(S,J)}catch(B){bJ("Caption DB transaction error",B)}}}};var dsH=class extends g.JW{constructor(S){super();this.C=S;this.N=this.C.observe(this.B.bind(this))}j9(){this.N&&this.N();super.j9()}async B(S){var W=S.transfer??new Set;S=[];for(const m of W)({entityId:W}=g.wy(m)),S.push(W);S.length!==0&&await BA$(this,S)}};var XeH=class extends g.JW{constructor(S,W,m,a){super();this.N=S;this.api=W;this.Hn=m;this.U=a;this.W=new g.qm;this.j=new g.rr(()=>{this.C&&this.C.transferState==="TRANSFER_STATE_TRANSFERRING"&&this.W.wp()&&((this.C.transferRetryCount||0)<3?I8(this.V,this.A,!1,!1):d8(this.V,this.A.videoDetails.videoId),this.Ej("TRANSFER_FAILURE_REASON_TIMEOUT_NO_PROGRESS"))});
this.iY=this.q2=0;this.S=this.Z=!1;this.ZQ=g.kW(this.api.K().experiments,"html5_transfer_processing_logs_interval");this.cn=new g.JC(this);this.eg={rrn:()=>this.j,
vKN:()=>this.U,
WN:()=>this.W};
this.bY=this.N.observe(this.TN.bind(this));this.V=new RIv(W,this);this.K_=new i29(W);this.vn=new dsH(this.N);this.GN=this.W.listen("publicytnetworkstatus-online",this.D8.bind(this));this.AX=this.W.listen("publicytnetworkstatus-offline",this.g2.bind(this));this.S=this.api.K().T("html5_less_transfer_processing_logs");g.R(this,this.cn);this.cn.L(W,"offlinetransferpause",this.hX);if(g.SB(this.api.K()))this.B="mainVideoDownloadStateEntity";else if(g.CG(this.api.K())||g.ma(this.api.K()))this.B="musicTrackDownloadMetadataEntity"}j9(){this.bY&&
this.bY();this.vn.dispose();this.j.dispose();this.GN&&g.KR(this.W.Ry,this.GN);this.AX&&g.KR(this.W.Ry,this.AX);super.j9()}async hX(S){const W=g.Sw(S,"transfer");if(this.C&&W===this.C.key)I8(this.V,this.A,!0),this.j.stop();else{const m=await e5(this.N,{mode:"readwrite",rd:!0},a=>XV(a,W,"transfer").then(J=>{if(J&&J.transferState!=="TRANSFER_STATE_COMPLETE"&&J.transferState!=="TRANSFER_STATE_FAILED")return J.transferState="TRANSFER_STATE_PAUSED_BY_USER",M4(a,J,"transfer").then(()=>J)}));
if(m){S&&this.B&&await mP(S,this.B,this.N,"DOWNLOAD_STATE_PAUSED");const a=await hl(this,S);fOp({videoId:S,rZ:m,offlineModeType:a})}}}g2(){if(this.C&&this.A){I8(this.V,this.A,!1);const S=this.C,W=S?.key?g.wy(S.key).entityId:"";W&&this.B&&(new Promise((m,a)=>{mP(W,this.B,this.N,"DOWNLOAD_STATE_PAUSED").catch(J=>{a(J)})})).catch(m=>{bJ("Download state setting error",m)})}this.j.stop()}D8(){this.C?upp(this,this.C):Zx(this)}async TN(S){if(this.C&&(this.C.transferState!=="TRANSFER_STATE_COMPLETE"&&this.C.transferState!==
"TRANSFER_STATE_FAILED"&&S.transfer&&S.transfer.has(this.C.key)&&((this.C=await dv(this.N,this.C.key,"transfer"))||await gV9(this)),this.C))return;
await Zx(this)}async Ej(S,W){if(this.C){var m=this.C;const J=m?.key?g.wy(m.key).entityId:"";a:switch(S){case "TRANSFER_FAILURE_REASON_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_EXTERNAL_FILESYSTEM_WRITE":case "TRANSFER_FAILURE_REASON_PLAYABILITY":case "TRANSFER_FAILURE_REASON_TOO_MANY_RETRIES":var a=!1;break a;default:a=!0}a&&OIH(this)?(await $x(this,"TRANSFER_STATE_TRANSFER_IN_QUEUE"),S=await hl(this,J),cK({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_RETRY"},{videoId:J,rZ:m,offlineModeType:S}),
J&&this.B&&await mP(J,this.B,this.N,"DOWNLOAD_STATE_RETRYABLE_FAILURE")):(await jFv(this,S),J&&this.B&&await mP(J,this.B,this.N,"DOWNLOAD_STATE_FAILED"))}else tl(this,`onTransferFailure: ${S}`);Al(this);m=Zx(this,!0);W&&W(m)}async gF(S){if(this.C)if(OIH(this)){await $x(this,"TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH");this.C||tl(this,"onMaybeTransferStreamsExpiredRetryAttempting");var W=this.C,m=W?.key?g.wy(W.key).entityId:"",a=await hl(this,m);cK({transferStatusType:"TRANSFER_STATUS_TYPE_DEQUEUED_BY_PLAYER_RESPONSE_EXPIRATION"},
{videoId:m,rZ:W,offlineModeType:a});W=y8();g.hj(W,L4,{isEnqueuedForExpiredStreamUrlRefetch:!0});a=g.Sw(m,"playbackData");m=K4(new Yx("playbackData",m,{actionType:"OFFLINE_ORCHESTRATION_ACTION_TYPE_ADD",entityKey:a,actionMetadata:W}));await xU(this.N,m,"offlineOrchestrationActionWrapperEntity")}else await jFv(this,"TRANSFER_FAILURE_REASON_STREAM_MISSING"),this.B&&(m=this.C,(m=m?.key?g.wy(m.key).entityId:"")&&await mP(m,this.B,this.N,"DOWNLOAD_STATE_FAILED"));else tl(this,"onMaybeTransferStreamsExpired");
Al(this);m=Zx(this,!0);S&&S(m)}},bu={TRANSFER_STATE_TRANSFERRING:1,TRANSFER_STATE_TRANSFER_IN_QUEUE:2};var IKp=class{constructor(S,W){this.Y=S;this.api=W;this.V=new g.qm;this.A=new g.YC;this.eg={GK:()=>this.B.eg.GK(),
WN:()=>this.V,
BU2:()=>this.B,
Xr:()=>this.Xr(),
XA:()=>this.XA(),
HK:()=>this.HK(),
SV:()=>this.SV(),
z5:()=>this.z5(),
t7:m=>this.t7(m)};
this.B=new Mx8(()=>QFQ(this),()=>{this.HK()},this.api.MP(),this.api.T.bind(this.api));
this.C=new lKN(this.api);x$9(this.B)}Xr(){return this.A.promise}XA(){if(this.N&&this.Z)return this.A.promise;HI8(this).then(this.A.resolve).catch(this.A.reject);return this.A.promise}W(S){return{playbackData:new Us8(S,this.Y,this.C),transfer:new eIn(S,this.Y),videoPlaybackPositionEntity:new LbQ(S,this.Y)}}async SV(){this.N&&await ql9(this.N)}async HK(){if(this.N||this.Z)await this.Xr(),this.iY!==void 0&&(g.I6(this.iY),this.iY=void 0),this.j!==void 0&&(g.I6(this.j),this.j=void 0),this.N?.dispose(),
this.N=void 0,this.Z?.dispose(),this.Z=void 0,g.AJ(this.api,"onOrchestrationLostLeader"),this.A=new g.YC}isOrchestrationLeader(){return this.B.C}async vn(){return!1}Cq(S){var W=this.C;W.api.publish("offlinetransferpause",S);W.N?.postMessage(S)}async D8(S){const W=await fS();if(W){var m=g.Sw(S,"transfer");await e5(W,{mode:"readwrite",rd:!0},a=>{const J=XV(a,m,"transfer"),B=XV(a,g.Sw(S,"videoDownloadContextEntity"),"videoDownloadContextEntity");return g.ho.all([J,B]).then(([E,z])=>E&&E.transferState===
"TRANSFER_STATE_PAUSED_BY_USER"?(E.transferState="TRANSFER_STATE_TRANSFER_IN_QUEUE",M4(a,E,"transfer").then(()=>{cK({transferStatusType:"TRANSFER_STATUS_TYPE_REENQUEUED_BY_USER_RESUME",statusType:"USER_RESUMED"},{videoId:S,rZ:E,offlineModeType:z?.offlineModeType});return g.ho.resolve(null)})):g.ho.resolve(null))})}}async bY(S=43200){if(!this.V.wp())return l09();
var W=await fS();if(!W)return[];const m=Date.now()/1E3;var a=await Id(W,"offlineVideoPolicy");W=[];for(const J of a)Number(J.lastUpdatedTimestampSeconds)+S<=m&&(a=g.wy(J.key).entityId,W.push(a));return W.length?o8(this,W,this.U,"OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH"):[]}deleteAll(){return o8(this,["!*$_ALL_ENTITIES_!*$"],this.U,"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}})}async refreshAllStaleEntities(S){return await this.bY(S)}setUpPositionSyncInterval(S){this.j!==
void 0&&(g.I6(this.j),this.j=void 0);const W=S??864E5;this.j=g.iP(()=>{this.t7(W)},W)}async t7(S){try{const W=await xx.getInstance();
if(!W)throw Error("prefStorage is undefined");const m=await W.get("psi"),a=m?.UF?Number(m.UF)/1E3:0,J=Date.now();a+S<=J&&await o8(this,["!*$_ALL_ENTITIES_!*$"],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_REFRESH")}catch(W){bJ("Offline manager error",W)}}async z5(){var S=await fS();if(!S)return[];var W=await Id(S,"transfer");S=[];for(const m of W)m.transferState==="TRANSFER_STATE_WAITING_FOR_PLAYER_RESPONSE_REFRESH"&&m.key&&(W=g.wy(m.key).entityId,S.push(W));return UR9(this,S)}async S(){return[]}async AX(){}async q2(){}};var P3Z=class extends aM{constructor(S,W,m){super(S);this.C=S;this.Y=W;this.B=m}N(S){return wv(S)?R5H(this,S):SQ(S)?xR8(this,S):WN(S)?iIn(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}},r8=[10];var fKx=class extends aM{constructor(S,W,m){super(S);this.C=S;this.Y=W;this.B=m}N(S){return wv(S)?h5H(this,S):SQ(S)?tqn(this,S):WN(S)?AiN(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}},$RN=[10];var knN=class extends aM{constructor(S,W,m){super(S);this.C=S;this.Y=W;this.B=m}N(S){return SQ(S)?bI$(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}};var $sZ=class extends IKp{constructor(){super(...arguments);this.U="mainVideoEntity"}W(S){const W=super.W(S);W.mainVideoEntity=new fKx(S,this.Y,this.C);W.mainPlaylistEntity=new P3Z(S,this.Y,this.C);W.mainDownloadsListEntity=new knN(S,this.Y,this.C);return W}async refreshAllStaleEntities(S,W){let m=[];this.Y.T("web_player_offline_playlist_auto_refresh")&&(m=await oVp(this,S,W));var a=await xx.getInstance();const J=await a?.get("sdois");a=await a?.get("lmqf");J&&(m=m.concat(await rig(this,J,a??"SD",
S===0)));return m=m.concat(await super.refreshAllStaleEntities(S,W))}async vn(S){var W=await fS();if(!W)return!1;W=await dv(W,g.AE,"mainDownloadsListEntity");if(W?.downloads?.length){S=g.Sw(S,"mainVideoEntity");for(const m of W.downloads)if(m.videoItem===S)return!0}return!1}async S(){var S=await fS();if(!S)return[];var W=await Id(S,"downloadStatusEntity");S=[];for(const m of W)m.downloadState==="DOWNLOAD_STATE_USER_DELETED"&&m.key&&(W=g.wy(m.key).entityId,S.push(W));return S.length?o8(this,S,"mainVideoEntity",
"OFFLINE_ORCHESTRATION_ACTION_TYPE_DELETE",{offlineLoggingData:{offlineDeleteReason:"OFFLINE_DELETE_REASON_USER_INITIATED"}}):[]}async q2(){const S=await fS();S&&await e5(S,{mode:"readwrite",rd:!0},W=>vK(W,"mainVideoEntity").then(m=>{const a=[];for(const J of m)J.userState?.playbackPosition||(m=g.wy(J.key).entityId,m={key:g.Sw(m,"videoPlaybackPositionEntity"),videoId:m,lastPlaybackPositionSeconds:"0"},a.push(M4(W,m,"videoPlaybackPositionEntity")),J.userState={playbackPosition:m.key},a.push(M4(W,J,
"mainVideoEntity")));return g.ho.all(a)}))}async AX(){const S=await fS();
if(S){var W=g.Sw("DOWNLOADS_LIST_ENTITY_ID_MANUAL_DOWNLOADS","mainDownloadsListEntity"),m=await e5(S,{mode:"readonly",rd:!0},K=>g.ho.all([XV(K,W,"mainDownloadsListEntity"),XV(K,g.AE,"mainDownloadsListEntity"),vK(K,"mainVideoEntity"),vK(K,"mainPlaylistEntity")])),[a,
J,B,E]=m;m=new Set;if(a?.downloads?.length)for(var z of a.downloads){var y=z.videoItem??z.playlistItem;y&&m.add(y)}if(J?.downloads?.length)for(var Y of J.downloads)Y.videoItem&&m.add(Y.videoItem);z=new Set;Y=[];for(var G of E){if(G.videos)for(const K of G.videos)(y=JSON.parse(g.wy(K).entityId).videoId)&&z.add(y);G.key&&!m.has(G.key)&&Y.push(G.key)}for(const K of B)K.key&&!m.has(K.key)&&(G=g.wy(K.key).entityId,z.has(G)||Y.push(K.key));Y.length&&await s3(S,Y)}}};var hIw=class extends aM{constructor(S,W){super(S);this.C=S;this.B=W}N(S){return wv(S)?ci$(this,S):SQ(S)?DR9(this,S):WN(S)?we$(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}},Dx=[10];var txH=class extends aM{constructor(S,W){super(S);this.C=S;this.B=W}N(S){return wv(S)?ms9(this,S):SQ(S)?aK$(this,S):WN(S)?J0Z(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}},w8=[10];var A0H=class extends aM{constructor(S,W){super(S);this.C=S;this.B=W}N(S){return wv(S)?YgH(this,S):SQ(S)?GnQ(this,S):WN(S)?KbQ(this,S):Promise.reject(Error(`Unsupported action type: ${S.actionType}`))}},y09=[10];var Z2Q=class extends IKp{constructor(){super(...arguments);this.U="musicTrack"}W(S){const W=super.W(S);W.musicTrack=new A0H(S,this.C);W.musicPlaylist=new txH(S,this.C);W.musicAlbumRelease=new hIw(S,this.C);return W}async refreshAllStaleEntities(S,W){let m=await qgQ(this,S,W);return m=m.concat(await super.refreshAllStaleEntities(S,W))}};g.FL("offline",class extends g.gL{constructor(){super(...arguments);this.events=new g.JC(this);this.Y=this.player.K();this.eg={jvq:()=>this.C,
nu:()=>this.nu(),
RZ:S=>this.RZ(S)}}create(){g.R(this,this.events);
if(g.SB(this.Y))this.C=new $sZ(this.Y,this.player);else if(g.CG(this.Y)||g.ma(this.Y))this.C=new Z2Q(this.Y,this.player);this.events.L(this.player,"onPlaybackStartExternal",()=>{this.nu()});
this.events.L(this.player,"videodatachange",()=>{this.nu()});
this.Y.T("html5_offline_playback_position_sync")&&this.events.L(this.player,"presentingplayerstatechange",this.RZ)}Pc(){return!1}async uy(S,W,m,a){return this.C?o8(this.C,S,W,m,a):Promise.reject()}deleteAll(){return this.C.deleteAll()}bY(S){return this.C.bY(S)}refreshAllStaleEntities(S){return this.C.refreshAllStaleEntities(S)}setUpPositionSyncInterval(S){this.C.setUpPositionSyncInterval(S)}Cq(S){this.C.Cq(S)}D8(S){return this.C.D8(S)}async nu(){const S=this.player.getVideoData();S.tv()&&pj9(S)&&
this.N!==S.clientPlaybackNonce&&await Fbg(this,S)}async RZ(S){var W=this.player.getVideoData();const m=W.sV;if(S.b$(2)||S.b$(512))(S=await fS())?(W=W.videoId,await dv(S,g.Sw(W,"mainVideoEntity"),"mainVideoEntity")&&await this.uy([W],"videoPlaybackPositionEntity","OFFLINE_ORCHESTRATION_ACTION_TYPE_UPDATE",{videoPlaybackPositionEntityActionMetadata:{lastPlaybackPositionSeconds:Math.floor(m).toString()}})):bJ("PES is undefined")}isOrchestrationLeader(){return this.C.isOrchestrationLeader()}async updateDownloadState(S,
W){const m=await fS();if(m){var {entityType:a,entityId:J}=g.wy(S);await mP(J,a,m,W,!0)}else bJ("PES is undefined")}});})(_yt_player);
